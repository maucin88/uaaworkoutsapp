<!DOCTYPE html>

<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TrainLog</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --ink: #0f0f0f; --paper: #f5f2ec; --accent: #d4522a;
      --accent-light: #f4e8e3; --muted: #8a8580; --border: #ddd9d0; --card: #ffffff;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Syne', sans-serif; background: var(--paper); color: var(--ink); min-height: 100vh; }
    .mono { font-family: 'DM Mono', monospace; }
    .tab-btn {
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.78rem;
      letter-spacing: 0.07em; text-transform: uppercase;
      padding: 0.5rem 1rem; border-bottom: 3px solid transparent;
      color: var(--muted); transition: color 0.2s, border-color 0.2s;
      background: none; border-top: none; border-left: none; border-right: none;
      cursor: pointer; white-space: nowrap;
    }
    .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-btn:hover:not(.active) { color: var(--ink); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    input, textarea, select {
      font-family: 'DM Mono', monospace; font-size: 0.88rem;
      background: var(--paper); border: 1.5px solid var(--border);
      border-radius: 6px; padding: 0.5rem 0.7rem;
      width: 100%; color: var(--ink); transition: border-color 0.2s;
      outline: none; -webkit-appearance: none;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--accent); }
    input[readonly] { background: #edeae3; color: var(--muted); cursor: default; }
    input::placeholder, textarea::placeholder { color: #bbb8b0; }
    label {
      font-size: 0.68rem; font-weight: 700; letter-spacing: 0.07em;
      text-transform: uppercase; color: var(--muted); display: block; margin-bottom: 0.25rem;
    }
    .date-auto { width: auto; min-width: 165px; display: inline-block; }
    .modal-date-input {
      font-family: 'DM Mono', monospace; font-size: 0.88rem;
      background: var(--paper); border: 1.5px solid var(--border);
      border-radius: 6px; padding: 0.5rem 0.7rem;
      width: 100%; color: var(--ink); transition: border-color 0.2s;
      outline: none; -webkit-appearance: none; display: block;
      cursor: pointer; min-height: 2.6rem;
    }
    .modal-date-input:focus { border-color: var(--accent); }
    .rpe-btn {
      font-family: 'DM Mono', monospace; font-size: 0.82rem;
      width: 2.2rem; height: 2.2rem; border-radius: 6px;
      border: 1.5px solid var(--border); background: var(--paper);
      color: var(--muted); cursor: pointer; transition: transform 0.12s;
      display: flex; align-items: center; justify-content: center; font-weight: 600;
    }
    .rpe-btn:hover { transform: scale(1.1); }
    .btn-primary {
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.82rem;
      letter-spacing: 0.06em; text-transform: uppercase;
      background: var(--accent); color: white; border: none;
      border-radius: 8px; padding: 0.65rem 1.75rem; cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }
    .btn-primary:hover { background: #b8401e; }
    .btn-primary:active { transform: scale(0.98); }
    .btn-secondary {
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.82rem;
      letter-spacing: 0.06em; text-transform: uppercase;
      background: transparent; color: var(--muted);
      border: 1.5px solid var(--border); border-radius: 8px;
      padding: 0.65rem 1.25rem; cursor: pointer; transition: all 0.2s;
    }
    .btn-secondary:hover { border-color: var(--muted); color: var(--ink); }
    .btn-ghost {
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.75rem;
      letter-spacing: 0.05em; text-transform: uppercase;
      background: transparent; color: var(--muted);
      border: 1.5px solid var(--border); border-radius: 6px;
      padding: 0.4rem 0.9rem; cursor: pointer; transition: all 0.2s;
    }
    .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
    .btn-ghost.active-panel { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
    .btn-plan {
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.82rem;
      letter-spacing: 0.06em; text-transform: uppercase;
      background: transparent; color: #1d4ed8;
      border: 1.5px solid #93c5fd; border-radius: 8px;
      padding: 0.65rem 1.25rem; cursor: pointer; transition: all 0.2s;
    }
    .btn-plan:hover { background: #eff6ff; border-color: #1d4ed8; }
    .form-card { background: var(--card); border: 1.5px solid var(--border); border-radius: 12px; padding: 1.25rem; }
    .form-card.editing { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    .edit-banner {
      background: var(--accent-light); border: 1.5px solid #e8c8bc;
      border-radius: 8px; padding: 0.55rem 1rem; margin-bottom: 0.75rem;
      font-size: 0.8rem; color: var(--accent); font-weight: 600;
      display: none; align-items: center; gap: 0.5rem;
    }
    .edit-banner.visible { display: flex; }
    .planned-section {
      background: #eff6ff; border: 1.5px solid #93c5fd;
      border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.25rem;
    }
    .planned-section-title {
      font-size: 0.68rem; font-weight: 700; letter-spacing: 0.1em;
      text-transform: uppercase; color: #1d4ed8; margin-bottom: 0.75rem;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .planned-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; }
    .planned-table { width: 100%; border-collapse: collapse; font-family: 'DM Mono', monospace; font-size: 0.78rem; }
    .planned-table thead th {
      background: #1d4ed8; color: white; padding: 0.45rem 0.65rem; text-align: left;
      font-family: 'Syne', sans-serif; font-size: 0.63rem;
      letter-spacing: 0.07em; text-transform: uppercase; font-weight: 700; white-space: nowrap;
    }
    .planned-table tbody tr { border-bottom: 1px solid #bfdbfe; transition: background 0.1s; }
    .planned-table tbody tr:hover { background: #dbeafe; }
    .planned-table tbody td { padding: 0.5rem 0.65rem; vertical-align: middle; color: var(--ink); }
    .execute-btn {
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.68rem;
      letter-spacing: 0.04em; text-transform: uppercase;
      background: #bbf7d0; color: #166534; border: 1.5px solid #86efac;
      border-radius: 5px; padding: 0.3rem 0.75rem; cursor: pointer;
      transition: background 0.15s; white-space: nowrap;
      display: inline-flex; align-items: center; gap: 0.4rem;
    }
    .execute-btn:hover { background: #86efac; border-color: #4ade80; }
    .plan-row-btn {
      font-family: 'DM Mono', monospace; font-size: 0.65rem;
      padding: 0.15rem 0.45rem; border-radius: 4px;
      border: 1px solid var(--border); background: none;
      color: var(--muted); cursor: pointer; transition: all 0.15s; margin-left: 2px;
    }
    .plan-row-btn:hover     { border-color: var(--accent); color: var(--accent); }
    .plan-row-btn.del:hover { border-color: #c62828; color: #c62828; }
    .modal-overlay {
      display: none; position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.45); align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: var(--card); border-radius: 14px; padding: 1.5rem;
      width: min(480px, 94vw); box-shadow: 0 8px 32px rgba(0,0,0,0.22);
      border: 1.5px solid var(--border);
    }
    .modal-title {
      font-size: 1rem; font-weight: 800; margin-bottom: 1.25rem; color: var(--ink);
      display: flex; align-items: center; justify-content: space-between;
    }
    .modal-close { background: none; border: none; cursor: pointer; font-size: 1.3rem; color: var(--muted); line-height: 1; padding: 0; }
    .modal-close:hover { color: var(--ink); }
    .data-table { width: 100%; border-collapse: collapse; font-family: 'DM Mono', monospace; font-size: 0.78rem; }
    .data-table thead th {
      background: var(--ink); color: var(--paper); padding: 0.5rem 0.65rem; text-align: left;
      font-family: 'Syne', sans-serif; font-size: 0.65rem;
      letter-spacing: 0.07em; text-transform: uppercase; font-weight: 700;
      white-space: nowrap; user-select: none; position: relative; z-index: 10;
    }
    .data-table thead th.sortable { cursor: pointer; }
    .data-table thead th.sortable:hover { background: #2a2a2a; }
    .data-table thead th .sort-icon { margin-left: 3px; font-size: 0.58rem; opacity: 0.5; }
    .data-table thead th.sort-asc  .sort-icon::after { content: '‚ñ≤'; opacity: 1; }
    .data-table thead th.sort-desc .sort-icon::after { content: '‚ñº'; opacity: 1; }
    .data-table thead th.sortable:not(.sort-asc):not(.sort-desc) .sort-icon::after { content: '‚áÖ'; }
    .data-table tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
    .data-table tbody tr:hover { background: #faf8f4; }
    .data-table tbody td { padding: 0.5rem 0.65rem; vertical-align: middle; }

```
/* ‚îÄ‚îÄ TASK & COMMENT CELLS ‚îÄ‚îÄ */
.task-cell {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  line-height: 1.35;
  color: var(--ink);
  min-width: 110px;
  max-width: 160px;
  word-break: break-word;
}
.task-cell.empty { color: var(--border); }
.comment-cell-inline {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  line-height: 1.35;
  color: #374151;
  min-width: 100px;
  max-width: 150px;
  word-break: break-word;
}
.comment-cell-inline.empty { color: var(--border); }
.comment-cell-inline.excl {
  color: #92400e;
  background: #fef3c7;
  border-radius: 3px;
  padding: 1px 3px;
}

/* ‚îÄ‚îÄ DATE CELL ‚îÄ‚îÄ */
.date-cell {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  white-space: nowrap;
  color: var(--ink);
}

.hr-cell { font-family: 'DM Mono', monospace; font-size: 0.75rem; white-space: nowrap; color: #e11d48; }
.compact-table-wrap { border-radius: 10px; border: 1.5px solid var(--border); overflow: hidden; }
.history-table-scroll { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 10px; border: 1.5px solid var(--border); }
.history-table-scroll .data-table { min-width: 1100px; }
.tag-sm {
  display: inline-block; font-family: 'DM Mono', monospace;
  font-size: 0.65rem; border-radius: 3px; padding: 0.1rem 0.42rem; white-space: nowrap;
  text-transform: lowercase;
}
.tag-activity    { background: #ede9fe; color: #5b21b6; }
.tag-type-blue   { background: #dbeafe; color: #1e40af; }
.tag-type-green  { background: #dcfce7; color: #15803d; }
.tag-type-orange { background: #ffedd5; color: #c2410c; }
.rpe-dot {
  display: inline-flex; align-items: center; justify-content: center;
  width: 1.6rem; height: 1.6rem; border-radius: 50%;
  font-size: 0.72rem; font-weight: 700; font-family: 'DM Mono', monospace;
}
.row-btn {
  font-family: 'DM Mono', monospace; font-size: 0.65rem;
  padding: 0.15rem 0.45rem; border-radius: 4px;
  border: 1px solid var(--border); background: none;
  color: var(--muted); cursor: pointer; transition: all 0.15s; margin-left: 2px;
}
.row-btn:hover     { border-color: var(--accent); color: var(--accent); }
.row-btn.del:hover { border-color: #c62828; color: #c62828; }
.zone-time-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 0.5rem; margin-top: 0.6rem; }
.zone-time-item label { font-size: 0.62rem; }
.zone-time-cell { font-family: 'DM Mono', monospace; font-size: 0.68rem; color: var(--muted); white-space: nowrap; }
.zone-time-cell span { display: inline-block; margin-right: 0.25rem; }
.zone-toggle-btn {
  background: none; border: none; cursor: pointer; font-size: 0.75rem;
  color: var(--paper); opacity: 0.7; padding: 0 0.2rem; vertical-align: middle;
}
.zone-toggle-btn:hover { opacity: 1; }
.excl-toggle {
  font-family: 'DM Mono', monospace; font-size: 0.8rem;
  padding: 0.2rem 0.55rem; border-radius: 5px;
  border: 1.5px solid var(--border); background: var(--paper);
  cursor: pointer; color: var(--muted); transition: all 0.15s;
  display: inline-flex; align-items: center; gap: 0.3rem;
}
.excl-toggle.on { background: #fef3c7; border-color: #f59e0b; color: #92400e; }
.ms-filter { position: relative; display: inline-block; }
.ms-trigger {
  font-family: 'DM Mono', monospace; font-size: 0.78rem;
  padding: 0.32rem 0.6rem; border: 1.5px solid var(--border);
  border-radius: 6px; background: var(--paper); color: var(--ink);
  cursor: pointer; display: flex; align-items: center; gap: 0.4rem;
  white-space: nowrap; transition: border-color 0.15s; user-select: none; min-width: 110px;
}
.ms-trigger:hover, .ms-trigger.open { border-color: var(--accent); }
.ms-trigger .ms-arrow { margin-left: auto; font-size: 0.55rem; color: var(--muted); transition: transform 0.15s; }
.ms-trigger.open .ms-arrow { transform: rotate(180deg); }
.ms-badge {
  background: var(--accent); color: white; border-radius: 10px;
  font-size: 0.6rem; font-weight: 700; padding: 0.05rem 0.35rem;
  font-family: 'Syne', sans-serif; min-width: 1.1rem; text-align: center;
}
.ms-dropdown {
  display: none; position: absolute; top: calc(100% + 4px); left: 0; z-index: 100;
  background: var(--card); border: 1.5px solid var(--border);
  border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.12);
  min-width: 180px; max-height: 260px; overflow-y: auto; padding: 0.35rem 0;
}
.ms-dropdown.open { display: block; }
.ms-option {
  display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; cursor: pointer;
  font-family: 'DM Mono', monospace; font-size: 0.78rem; color: var(--ink); transition: background 0.1s;
}
.ms-option:hover { background: var(--paper); }
.ms-option input[type="checkbox"] {
  width: 0.9rem; height: 0.9rem; accent-color: var(--accent);
  cursor: pointer; flex-shrink: 0; border: none; padding: 0;
  -webkit-appearance: auto; appearance: auto;
}
.ms-divider { height: 1px; background: var(--border); margin: 0.25rem 0; }
.ms-clear {
  font-family: 'Syne', sans-serif; font-size: 0.65rem; font-weight: 700;
  color: var(--accent); padding: 0.3rem 0.75rem; cursor: pointer;
  letter-spacing: 0.05em; text-transform: uppercase;
}
.ms-clear:hover { text-decoration: underline; }
.filter-bar { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; margin-bottom: 1rem; }
.filter-group { display: flex; align-items: center; gap: 0.3rem; }
.filter-group label { display: inline; font-size: 0.65rem; margin: 0; white-space: nowrap; }
.profile-card { background: var(--card); border: 1.5px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.25rem; }
.section-title { font-size: 0.68rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.75rem; }
.zone-table { width: 100%; border-collapse: collapse; font-family: 'DM Mono', monospace; font-size: 0.82rem; }
.zone-table th {
  background: var(--ink); color: var(--paper); padding: 0.45rem 0.6rem; text-align: center;
  font-family: 'Syne', sans-serif; font-size: 0.63rem; letter-spacing: 0.06em; text-transform: uppercase; font-weight: 700;
}
.zone-table td { padding: 0.4rem 0.5rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
.zone-table td:first-child { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.78rem; white-space: nowrap; }
.zone-table input { font-size: 0.82rem; padding: 0.3rem 0.4rem; text-align: center; }
.zone-1{color:#38bdf8;} .zone-2{color:#1d4ed8;} .zone-3{color:#16a34a;} .zone-4{color:#ea580c;} .zone-5{color:#dc2626;}
.validation-error { font-family: 'DM Mono', monospace; font-size: 0.72rem; color: #c62828; margin-top: 0.5rem; display: none; }
.import-box {
  border: 2px dashed var(--border); border-radius: 10px;
  padding: 1.25rem; text-align: center; cursor: pointer;
  transition: border-color 0.2s, background 0.2s; display: block;
}
.import-box:hover { border-color: var(--accent); background: var(--accent-light); }
.import-box input[type="file"] { display: none; }
.import-log {
  font-family: 'DM Mono', monospace; font-size: 0.75rem;
  background: #0f0f0f; color: #86efac; border-radius: 8px;
  padding: 0.75rem 1rem; margin-top: 0.75rem;
  max-height: 200px; overflow-y: auto; display: none; text-align: left; line-height: 1.7;
}
.show-all-link { font-family: 'Syne', sans-serif; font-size: 0.78rem; font-weight: 700; color: var(--accent); cursor: pointer; border: none; background: none; padding: 0; }
.show-all-link:hover { text-decoration: underline; }
.empty-state { text-align: center; padding: 2.5rem 1rem; color: var(--muted); }
.empty-state .big { font-size: 2.5rem; margin-bottom: 0.4rem; }
@keyframes fadeSlideIn { from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);} }
.animate-in { animation: fadeSlideIn 0.25s ease forwards; }
::-webkit-scrollbar { width:5px; height:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
.summary-card { background: var(--card); border: 1.5px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.25rem; }
.range-btn {
  font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.72rem;
  letter-spacing: 0.06em; text-transform: uppercase;
  background: transparent; color: var(--muted);
  border: 1.5px solid var(--border); border-radius: 6px;
  padding: 0.4rem 0.85rem; cursor: pointer; transition: all 0.18s;
}
.range-btn:hover { border-color: var(--accent); color: var(--accent); }
.range-btn.active { background: var(--ink); color: var(--paper); border-color: var(--ink); }
.nav-btn {
  font-family: 'DM Mono', monospace; font-weight: 700; font-size: 1rem;
  background: var(--card); color: var(--ink);
  border: 1.5px solid var(--border); border-radius: 8px;
  width: 2.4rem; height: 2.4rem; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s; flex-shrink: 0;
}
.nav-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
.nav-btn:disabled { opacity: 0.3; cursor: default; }
.period-label {
  font-family: 'DM Mono', monospace; font-size: 0.82rem;
  color: var(--ink); text-align: center; flex: 1; padding: 0 0.5rem; font-weight: 500;
}
.stat-pill {
  background: var(--paper); border: 1.5px solid var(--border); border-radius: 10px; padding: 0.65rem 1rem;
  display: flex; flex-direction: column; gap: 0.2rem; flex: 1; min-width: 0;
}
.stat-pill-label { font-family: 'Syne', sans-serif; font-size: 0.6rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); }
.stat-pill-value { font-family: 'DM Mono', monospace; font-size: 1.05rem; font-weight: 500; color: var(--ink); white-space: nowrap; }
.chart-wrap { position: relative; width: 100%; }
```

  </style>
</head>
<body>

<!-- PLAN MODAL -->

<div class="modal-overlay" id="plan-modal" onclick="if(event.target===this)closePlanModal()">
  <div class="modal-box">
    <div class="modal-title">
      <span id="modal-title-text">üìÖ Zaplanuj trening</span>
      <button class="modal-close" onclick="closePlanModal()">√ó</button>
    </div>
    <div class="mb-3"><label>Data (opcjonalnie)</label><input type="date" id="pm-date" class="modal-date-input" /></div>
    <div class="mb-3"><label>Rodzaj treningu</label>
      <select id="pm-type">
        <option value="baza tlenowa">baza tlenowa</option><option value="zabawa biegowa">zabawa biegowa</option>
        <option value="oko≈Ço progowy">oko≈Ço progowy</option><option value="ciƒÖg≈Çy">ciƒÖg≈Çy</option>
        <option value="interwa≈Çowy">interwa≈Çowy</option><option value="inny">inny</option>
      </select>
    </div>
    <div class="mb-3"><label>Zadanie</label><input type="text" id="pm-task" placeholder="np. 4√ó500m p. 2 min" /></div>
    <div class="mb-4"><label>Uwagi</label><textarea id="pm-notes" rows="3" placeholder="Dodatkowe uwagi..." style="resize:none;"></textarea></div>
    <div class="flex gap-3">
      <button class="btn-primary" id="pm-save-btn" onclick="savePlan()">Zapisz plan</button>
      <button class="btn-secondary" onclick="closePlanModal()">Anuluj</button>
    </div>
  </div>
</div>

<!-- HEADER -->

<header class="sticky top-0 z-50" style="background:var(--paper);border-bottom:1.5px solid var(--border);">
  <div class="max-w-5xl mx-auto px-4">
    <div class="flex items-baseline gap-3 pt-3 pb-1">
      <h1 class="text-xl font-extrabold tracking-tight">Train<span style="color:var(--accent)">Log</span></h1>
      <span class="mono text-xs" style="color:var(--muted);">v1.4</span>
    </div>
    <nav class="flex mt-1" style="overflow-x:auto;-webkit-overflow-scrolling:touch;gap:0;">
      <button class="tab-btn" data-tab="profile">Profil</button>
      <button class="tab-btn active" data-tab="endurance">Wytrzyma≈Ço≈õƒá</button>
      <button class="tab-btn" data-tab="fitness">Sprawno≈õƒá</button>
      <button class="tab-btn" data-tab="summary">Podsumowanie</button>
    </nav>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-5">

  <!-- WYTRZYMA≈ÅO≈öƒÜ -->

  <div id="tab-endurance" class="tab-content active animate-in">
    <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
      <h2 class="text-lg font-bold">Wytrzyma≈Ço≈õƒá</h2>
      <button class="btn-plan" onclick="openPlanModal()">+ Zaplanuj trening</button>
    </div>
    <div class="planned-section" id="planned-section" style="display:none;">
      <div class="planned-section-title">üìã Zaplanowane <span class="mono" style="font-size:0.65rem;color:#3b82f6;font-weight:400;" id="planned-count"></span></div>
      <div class="planned-scroll">
        <table class="planned-table">
          <thead><tr><th>Data</th><th>Typ</th><th>Zadanie</th><th>Uwagi</th><th></th></tr></thead>
          <tbody id="planned-tbody"></tbody>
        </table>
      </div>
    </div>
    <div class="edit-banner" id="edit-banner">
      ‚úèÔ∏è Tryb edycji
      <button onclick="cancelEdit()" style="margin-left:auto;font-size:0.73rem;text-decoration:underline;background:none;border:none;color:var(--accent);cursor:pointer;font-family:'Syne',sans-serif;font-weight:700;">Anuluj</button>
    </div>
    <div class="form-card mb-5" id="form-card">
      <div id="plan-source-banner" style="display:none;background:#eff6ff;border:1.5px solid #93c5fd;border-radius:6px;padding:0.4rem 0.75rem;margin-bottom:0.75rem;font-size:0.78rem;color:#1d4ed8;font-family:'Syne',sans-serif;font-weight:600;align-items:center;gap:0.4rem;">
        üìã Realizujesz zaplanowany trening
        <button onclick="clearPlanSource()" style="margin-left:auto;font-size:0.72rem;text-decoration:underline;background:none;border:none;color:#1d4ed8;cursor:pointer;font-family:'Syne',sans-serif;font-weight:700;">Od≈ÇƒÖcz</button>
      </div>
      <div class="mb-3"><label>Data treningu</label><input type="date" id="f-date" class="date-auto" /></div>
      <div class="grid grid-cols-2 gap-3 mb-3">
        <div><label>Rodzaj aktywno≈õci</label>
          <select id="f-activity">
            <option value="bieg">bieg</option><option value="stadion">stadion</option>
            <option value="bie≈ºnia">bie≈ºnia</option><option value="inny">inny</option>
          </select>
        </div>
        <div><label>Rodzaj treningu</label>
          <select id="f-type">
            <option value="baza tlenowa">baza tlenowa</option><option value="zabawa biegowa">zabawa biegowa</option>
            <option value="oko≈Ço progowy">oko≈Ço progowy</option><option value="ciƒÖg≈Çy">ciƒÖg≈Çy</option>
            <option value="interwa≈Çowy">interwa≈Çowy</option><option value="inny">inny</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3 mb-3">
        <div><label>Dystans (km)</label><input type="number" id="f-distance" placeholder="0.00" step="0.01" min="0" /></div>
        <div><label>Akcent (km)</label><input type="number" id="f-accent" placeholder="0.00" step="0.01" min="0" /></div>
      </div>
      <div class="grid grid-cols-2 gap-3 mb-3">
        <div><label>Czas</label><input type="text" id="f-duration" placeholder="00:00" inputmode="numeric" /></div>
        <div><label>≈örednie tempo (min/km)</label><input type="text" id="f-pace" readonly placeholder="‚Äî" /></div>
      </div>
      <div class="grid grid-cols-2 gap-3 mb-4">
        <div><label>≈örednie tƒôtno (bpm)</label><input type="number" id="f-hr" placeholder="np. 145" min="30" max="250" /></div>
        <div></div>
      </div>
      <div class="mb-3">
        <button class="btn-ghost" id="task-toggle-btn" onclick="toggleTask()">Zadanie</button>
        <div id="task-field" style="display:none;margin-top:0.6rem;"><label>Opis zadania</label><input type="text" id="f-task" placeholder="np. 4√ó500m p. 2 min" /></div>
      </div>
      <div class="mb-3">
        <div class="flex items-center gap-3 mb-2 flex-wrap">
          <label style="margin:0;">Ocena wysi≈Çku (RPE)</label>
          <button class="btn-ghost" id="zone-time-toggle-btn" onclick="toggleZoneTime()">Czas w strefach</button>
        </div>
        <div class="flex flex-wrap gap-2" id="rpe-buttons"></div>
      </div>
      <div id="zone-time-fields" style="display:none;" class="mb-4">
        <div class="zone-time-grid">
          <div class="zone-time-item"><label style="color:#38bdf8;">Strefa 1</label><input type="text" id="zt-1" placeholder="00:00" inputmode="numeric" /></div>
          <div class="zone-time-item"><label style="color:#1d4ed8;">Strefa 2</label><input type="text" id="zt-2" placeholder="00:00" inputmode="numeric" /></div>
          <div class="zone-time-item"><label style="color:#16a34a;">Strefa 3</label><input type="text" id="zt-3" placeholder="00:00" inputmode="numeric" /></div>
          <div class="zone-time-item"><label style="color:#ea580c;">Strefa 4</label><input type="text" id="zt-4" placeholder="00:00" inputmode="numeric" /></div>
          <div class="zone-time-item"><label style="color:#dc2626;">Strefa 5</label><input type="text" id="zt-5" placeholder="00:00" inputmode="numeric" /></div>
        </div>
      </div>
      <div class="mb-4">
        <label>Komentarz</label>
        <textarea id="f-note" rows="2" placeholder="Kr√≥tki komentarz..." style="resize:none;"></textarea>
        <div style="display:flex;align-items:center;gap:0.6rem;margin-top:0.5rem;">
          <button class="excl-toggle" id="excl-btn" onclick="toggleExcl()">‚ùó Wa≈ºne</button>
        </div>
      </div>
      <div class="flex items-center gap-3 flex-wrap">
        <button class="btn-primary" id="add-btn">+ Dodaj trening</button>
        <button class="btn-secondary" id="cancel-btn" onclick="cancelEdit()" style="display:none;">Anuluj</button>
        <span class="mono text-xs" id="form-error" style="color:var(--accent);display:none;"></span>
      </div>
    </div>
    <div class="flex items-center justify-between mb-2">
      <span class="section-title" style="margin:0;">Ostatnie treningi</span>
    </div>
    <div class="compact-table-wrap mb-3"><div id="endurance-table-body"></div></div>
    <div style="text-align:right;"><button class="show-all-link" onclick="openHistory()">Zobacz wszystkie ‚Üí</button></div>
  </div>

  <!-- HISTORIA -->

  <div id="tab-history" class="tab-content">
    <div class="flex items-center gap-3 mb-4 flex-wrap">
      <h2 class="text-lg font-bold">Historia</h2>
      <button class="btn-ghost" onclick="switchTab('endurance')" style="font-size:0.7rem;">‚Üê Wr√≥ƒá</button>
    </div>
    <div class="filter-bar">
      <div class="filter-group"><label>Rok</label>
        <select id="h-filter-year" onchange="renderHistory()" style="width:auto;font-size:0.78rem;padding:0.3rem 0.55rem;"><option value="">Wszystkie</option></select>
      </div>
      <div class="filter-group"><label>MiesiƒÖc</label>
        <div class="ms-filter" id="ms-month">
          <div class="ms-trigger" onclick="toggleMsDropdown('ms-month')"><span class="ms-label">Wszystkie</span><span class="ms-badge" style="display:none;"></span><span class="ms-arrow">‚ñº</span></div>
          <div class="ms-dropdown">
            <div class="ms-clear" onclick="clearMs('ms-month')">Wyczy≈õƒá</div><div class="ms-divider"></div>
            <label class="ms-option"><input type="checkbox" value="01" onchange="msChanged('ms-month')"> Stycze≈Ñ</label>
            <label class="ms-option"><input type="checkbox" value="02" onchange="msChanged('ms-month')"> Luty</label>
            <label class="ms-option"><input type="checkbox" value="03" onchange="msChanged('ms-month')"> Marzec</label>
            <label class="ms-option"><input type="checkbox" value="04" onchange="msChanged('ms-month')"> Kwiecie≈Ñ</label>
            <label class="ms-option"><input type="checkbox" value="05" onchange="msChanged('ms-month')"> Maj</label>
            <label class="ms-option"><input type="checkbox" value="06" onchange="msChanged('ms-month')"> Czerwiec</label>
            <label class="ms-option"><input type="checkbox" value="07" onchange="msChanged('ms-month')"> Lipiec</label>
            <label class="ms-option"><input type="checkbox" value="08" onchange="msChanged('ms-month')"> Sierpie≈Ñ</label>
            <label class="ms-option"><input type="checkbox" value="09" onchange="msChanged('ms-month')"> Wrzesie≈Ñ</label>
            <label class="ms-option"><input type="checkbox" value="10" onchange="msChanged('ms-month')"> Pa≈∫dziernik</label>
            <label class="ms-option"><input type="checkbox" value="11" onchange="msChanged('ms-month')"> Listopad</label>
            <label class="ms-option"><input type="checkbox" value="12" onchange="msChanged('ms-month')"> Grudzie≈Ñ</label>
          </div>
        </div>
      </div>
      <div class="filter-group"><label>Akt.</label>
        <div class="ms-filter" id="ms-activity">
          <div class="ms-trigger" onclick="toggleMsDropdown('ms-activity')"><span class="ms-label">Wszystkie</span><span class="ms-badge" style="display:none;"></span><span class="ms-arrow">‚ñº</span></div>
          <div class="ms-dropdown">
            <div class="ms-clear" onclick="clearMs('ms-activity')">Wyczy≈õƒá</div><div class="ms-divider"></div>
            <label class="ms-option"><input type="checkbox" value="bieg" onchange="msChanged('ms-activity')"> bieg</label>
            <label class="ms-option"><input type="checkbox" value="stadion" onchange="msChanged('ms-activity')"> stadion</label>
            <label class="ms-option"><input type="checkbox" value="bie≈ºnia" onchange="msChanged('ms-activity')"> bie≈ºnia</label>
            <label class="ms-option"><input type="checkbox" value="inny" onchange="msChanged('ms-activity')"> inny</label>
          </div>
        </div>
      </div>
      <div class="filter-group"><label>Typ</label>
        <div class="ms-filter" id="ms-type">
          <div class="ms-trigger" onclick="toggleMsDropdown('ms-type')"><span class="ms-label">Wszystkie</span><span class="ms-badge" style="display:none;"></span><span class="ms-arrow">‚ñº</span></div>
          <div class="ms-dropdown">
            <div class="ms-clear" onclick="clearMs('ms-type')">Wyczy≈õƒá</div><div class="ms-divider"></div>
            <label class="ms-option"><input type="checkbox" value="baza tlenowa" onchange="msChanged('ms-type')"> baza tlenowa</label>
            <label class="ms-option"><input type="checkbox" value="zabawa biegowa" onchange="msChanged('ms-type')"> zabawa biegowa</label>
            <label class="ms-option"><input type="checkbox" value="oko≈Ço progowy" onchange="msChanged('ms-type')"> oko≈Ço progowy</label>
            <label class="ms-option"><input type="checkbox" value="ciƒÖg≈Çy" onchange="msChanged('ms-type')"> ciƒÖg≈Çy</label>
            <label class="ms-option"><input type="checkbox" value="interwa≈Çowy" onchange="msChanged('ms-type')"> interwa≈Çowy</label>
            <label class="ms-option"><input type="checkbox" value="inny" onchange="msChanged('ms-type')"> inny</label>
          </div>
        </div>
      </div>
      <div class="filter-group"><label>RPE</label>
        <select id="h-filter-rpe" onchange="renderHistory()" style="width:auto;font-size:0.78rem;padding:0.3rem 0.55rem;">
          <option value="">Wszystkie</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
        </select>
      </div>
      <button class="btn-secondary" style="padding:0.32rem 0.7rem;font-size:0.72rem;" onclick="clearAllFilters()">Wyczy≈õƒá wszystko</button>
    </div>
    <div class="history-table-scroll"><div id="history-table-body"></div></div>
  </div>

  <!-- SPRAWNO≈öƒÜ -->

  <div id="tab-fitness" class="tab-content">
    <h2 class="text-lg font-bold mb-3">Sprawno≈õƒá</h2>
    <div class="empty-state"><div class="big">üèãÔ∏è</div><p class="font-semibold" style="color:var(--muted);">Wkr√≥tce tutaj</p></div>
  </div>

  <!-- PODSUMOWANIE -->

  <div id="tab-summary" class="tab-content animate-in">
    <h2 class="text-lg font-bold mb-4">Podsumowanie</h2>
    <div class="summary-card">
      <div class="flex flex-wrap gap-2 mb-4">
        <button class="range-btn active" data-range="week"    onclick="setSummaryRange('week')">Tydzie≈Ñ</button>
        <button class="range-btn"        data-range="month"   onclick="setSummaryRange('month')">MiesiƒÖc</button>
        <button class="range-btn"        data-range="12weeks" onclick="setSummaryRange('12weeks')">12 tygodni</button>
        <button class="range-btn"        data-range="year"    onclick="setSummaryRange('year')">Rok</button>
      </div>
      <div class="flex items-center gap-2 mb-4">
        <button class="nav-btn" id="sum-prev" onclick="summaryNav(-1)">‚Äπ</button>
        <div class="period-label" id="sum-period-label">‚Äî</div>
        <button class="nav-btn" id="sum-next" onclick="summaryNav(1)">‚Ä∫</button>
      </div>
      <div class="flex gap-2 mb-5 flex-wrap">
        <div class="stat-pill"><span class="stat-pill-label">≈ÅƒÖczny dystans</span><span class="stat-pill-value" id="stat-total">‚Äî km</span></div>
        <div class="stat-pill"><span class="stat-pill-label">Akcent</span><span class="stat-pill-value" id="stat-accent">‚Äî km</span></div>
        <div class="stat-pill"><span class="stat-pill-label">Trening√≥w</span><span class="stat-pill-value" id="stat-count">‚Äî</span></div>
        <div class="stat-pill"><span class="stat-pill-label">Udzia≈Ç akcent√≥w</span><span class="stat-pill-value" id="stat-accent-pct">‚Äî %</span></div>
      </div>
      <div class="chart-wrap" style="height:300px;"><canvas id="summary-chart"></canvas></div>
      <div class="flex gap-4 mt-3 justify-center" style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted);">
        <span style="display:flex;align-items:center;gap:0.35rem;"><span style="width:12px;height:12px;border-radius:3px;background:rgba(164,198,229,0.9);display:inline-block;"></span>Dystans ca≈Çkowity</span>
        <span style="display:flex;align-items:center;gap:0.35rem;"><span style="width:12px;height:12px;border-radius:3px;background:rgba(255,159,64,0.9);display:inline-block;"></span>Akcent (przesuniƒôty w prawo)</span>
      </div>
    </div>
  </div>

  <!-- PROFIL -->

  <div id="tab-profile" class="tab-content">
    <h2 class="text-lg font-bold mb-4">Profil</h2>
    <div class="profile-card">
      <div class="section-title">Dane fizyczne</div>
      <div class="grid grid-cols-2 gap-3">
        <div><label>Wzrost (cm)</label><input type="number" id="p-height" placeholder="175" min="100" max="250" /></div>
        <div><label>Waga (kg)</label><input type="number" id="p-weight" placeholder="70.0" step="0.1" min="30" max="300" /></div>
      </div>
    </div>
    <div class="profile-card">
      <div class="section-title">Strefy treningowe</div>
      <div style="overflow-x:auto;border-radius:8px;border:1.5px solid var(--border);">
        <table class="zone-table">
          <thead>
            <tr>
              <th rowspan="2" style="text-align:left;padding-left:0.75rem;">Strefa</th>
              <th colspan="2">Tƒôtno (BPM)</th><th colspan="2">Tempo (min/km)</th><th colspan="2">Moc (W)</th>
            </tr>
            <tr style="background:#222;"><th>Min</th><th>Max</th><th>Min</th><th>Max</th><th>Min</th><th>Max</th></tr>
          </thead>
          <tbody id="zone-tbody"></tbody>
        </table>
      </div>
      <div class="validation-error" id="zone-error">‚ö†Ô∏è Minimum strefy wy≈ºszej musi byƒá wiƒôksze ni≈º maksimum strefy ni≈ºszej.</div>
      <div style="margin-top:1rem;display:flex;align-items:center;gap:1rem;">
        <button class="btn-primary" onclick="saveProfile()">Zapisz profil</button>
        <span class="mono text-xs" id="profile-saved" style="color:#2e7d32;display:none;">‚úì Zapisano</span>
      </div>
    </div>
    <div class="profile-card">
      <div class="section-title">Import danych (CSV)</div>
      <p class="mono" style="font-size:0.73rem;color:var(--muted);margin-bottom:0.75rem;line-height:1.65;">
        Separator: <strong>≈õrednik (;)</strong> ¬∑ Kodowanie: <strong>UTF-8 lub Windows-1250</strong><br>
        Kolumny (0‚Äì14): <strong>Data ¬∑ Aktywno≈õƒá ¬∑ Typ ¬∑ Dystans ¬∑ Akcent ¬∑ Czas ¬∑ RPE ¬∑ Zadanie ¬∑ Notatka ¬∑ Tƒôtno ¬∑ S1‚ÄìS5</strong>
      </p>
      <label class="import-box" for="csv-file-input">
        <input type="file" id="csv-file-input" accept=".csv,.txt" onchange="handleCsvImport(event)" />
        <div style="font-size:2rem;margin-bottom:0.35rem;">üìÇ</div>
        <div class="font-bold" style="font-size:0.85rem;">Kliknij lub upu≈õƒá plik CSV</div>
        <div class="mono" style="font-size:0.7rem;color:var(--muted);margin-top:0.25rem;">UTF-8 lub Windows-1250, separator ≈õrednik (;)</div>
      </label>
      <div class="import-log" id="import-log"></div>
      <div style="margin-top:0.75rem;display:flex;gap:0.75rem;flex-wrap:wrap;">
        <button class="btn-secondary" style="font-size:0.72rem;padding:0.4rem 0.9rem;" onclick="downloadSampleCsv()">‚¨á Pobierz przyk≈Çadowy CSV</button>
        <button class="btn-secondary" style="font-size:0.72rem;padding:0.4rem 0.9rem;color:#c62828;border-color:#fca5a5;" onclick="clearAllTrainings()">üóë Wyczy≈õƒá wszystkie treningi</button>
      </div>
    </div>
  </div>

</main>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CZƒò≈öƒÜ 3: LOGIKA JAVASCRIPT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê STORAGE ‚ïê‚ïê‚ïê
const STORAGE_KEY=‚Äòtrainlog_endurance_v1‚Äô,PROFILE_KEY=‚Äòtrainlog_profile_v1‚Äô,PLANNED_KEY=‚Äòtrainlog_planned_v1‚Äô;
const ZONE_DISPLAY=[{num:5,label:‚Äô> Strefa 5‚Äô,cls:‚Äòzone-5‚Äô},{num:4,label:‚ÄòStrefa 4‚Äô,cls:‚Äòzone-4‚Äô},{num:3,label:‚ÄòStrefa 3‚Äô,cls:‚Äòzone-3‚Äô},{num:2,label:‚ÄòStrefa 2‚Äô,cls:‚Äòzone-2‚Äô},{num:1,label:‚ÄòStrefa 1‚Äô,cls:‚Äòzone-1‚Äô}];
const RPE_PALETTE={1:{bg:‚Äô#e0f2fe‚Äô,border:‚Äô#7dd3fc‚Äô,text:‚Äô#0369a1‚Äô},2:{bg:‚Äô#bae6fd‚Äô,border:‚Äô#38bdf8‚Äô,text:‚Äô#0369a1‚Äô},3:{bg:‚Äô#7dd3fc‚Äô,border:‚Äô#0ea5e9‚Äô,text:‚Äô#0c4a6e‚Äô},4:{bg:‚Äô#a7f3d0‚Äô,border:‚Äô#34d399‚Äô,text:‚Äô#065f46‚Äô},5:{bg:‚Äô#fef08a‚Äô,border:‚Äô#facc15‚Äô,text:‚Äô#854d0e‚Äô},6:{bg:‚Äô#fde047‚Äô,border:‚Äô#eab308‚Äô,text:‚Äô#713f12‚Äô},7:{bg:‚Äô#fed7aa‚Äô,border:‚Äô#fb923c‚Äô,text:‚Äô#9a3412‚Äô},8:{bg:‚Äô#fdba74‚Äô,border:‚Äô#f97316‚Äô,text:‚Äô#7c2d12‚Äô},9:{bg:‚Äô#fca5a5‚Äô,border:‚Äô#ef4444‚Äô,text:‚Äô#991b1b‚Äô},10:{bg:‚Äô#4c1d95‚Äô,border:‚Äô#7c3aed‚Äô,text:‚Äô#ede9fe‚Äô}};
function loadTrainings(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||[];}catch{return[];}}
function saveTrainings(d){localStorage.setItem(STORAGE_KEY,JSON.stringify(d));}
function loadProfile(){try{return JSON.parse(localStorage.getItem(PROFILE_KEY))||{};}catch{return {};}}
function saveProfileData(d){localStorage.setItem(PROFILE_KEY,JSON.stringify(d));}
function loadPlanned(){try{return JSON.parse(localStorage.getItem(PLANNED_KEY))||[];}catch{return[];}}
function savePlanned(d){localStorage.setItem(PLANNED_KEY,JSON.stringify(d));}

// ‚ïê‚ïê‚ïê ENCODING ‚ïê‚ïê‚ïê
function readFileWithEncodingDetection(file){
return new Promise((resolve,reject)=>{
const reader=new FileReader();
reader.onerror=()=>reject(new Error(‚ÄòB≈ÇƒÖd odczytu pliku‚Äô));
reader.onload=(e)=>{
const buffer=e.target.result;
const utf8=new TextDecoder(‚Äòutf-8‚Äô,{fatal:false}).decode(buffer);
if(utf8.includes(‚Äô\uFFFD‚Äô)){
try{resolve({text:new TextDecoder(‚Äòwindows-1250‚Äô,{fatal:false}).decode(buffer),encoding:‚Äòwindows-1250‚Äô});}
catch{resolve({text:decodeCp1250(buffer),encoding:‚Äòwindows-1250 (manual)‚Äô});}
} else {resolve({text:utf8,encoding:‚Äòutf-8‚Äô});}
};
reader.readAsArrayBuffer(file);
});
}
function decodeCp1250(buffer){
const bytes=new Uint8Array(buffer);
const extra=‚Äô\u20AC\uFFFD\u201A\uFFFD\u201E\u2026\u2020\u2021\uFFFD\u2030\u0160\u2039\u015A\u0164\u017D\u0179\uFFFD\u2018\u2019\u201C\u201D\u2022\u2013\u2014\uFFFD\u2122\u0161\u203A\u015B\u0165\u017E\u017A\u00A0\u02C7\u02D8\u0141\u00A4\u0104\u00A6\u00A7\u00A8\u00A9\u015E\u00AB\u00AC\u00AD\u00AE\u017B\u00B0\u00B1\u02DB\u0142\u00B4\u00B5\u00B6\u00B7\u00B8\u0105\u015F\u00BB\u013D\u02DD\u013E\u017C\u0154\u00C1\u00C2\u0102\u00C4\u0139\u0106\u00C7\u010C\u00C9\u0118\u00CB\u011A\u00CD\u00CE\u010E\u0110\u0143\u0147\u00D3\u00D4\u0150\u00D6\u00D7\u0158\u016E\u00DA\u0170\u00DC\u00DD\u0162\u00DF\u0155\u00E1\u00E2\u0103\u00E4\u013A\u0107\u00E7\u010D\u00E9\u0119\u00EB\u011B\u00ED\u00EE\u010F\u0111\u0144\u0148\u00F3\u00F4\u0151\u00F6\u00F7\u0159\u016F\u00FA\u0171\u00FC\u00FD\u0163\u02D9‚Äô;
let r=‚Äô‚Äô;for(let i=0;i<bytes.length;i++){const b=bytes[i];r+=b<0x80?String.fromCharCode(b):(extra[b-0x80]||‚Äô\uFFFD‚Äô);}return r;
}

// ‚ïê‚ïê‚ïê NORMALISE ‚ïê‚ïê‚ïê
function normaliseActivity(raw){if(!raw)return‚Äôbieg‚Äô;const s=raw.toLowerCase().trim();if(s.includes(‚Äòlekkoatletyczn‚Äô)||s===‚Äòstadion‚Äô)return‚Äôstadion‚Äô;if(s.includes(‚Äòmechaniczn‚Äô)||s===‚Äòbie≈ºnia‚Äô||s===‚Äòbieznia‚Äô)return‚Äôbie≈ºnia‚Äô;if(s.includes(‚Äòbieg‚Äô))return‚Äôbieg‚Äô;if(s===‚Äòinny‚Äô)return‚Äôinny‚Äô;return s||‚Äòbieg‚Äô;}
function normaliseType(raw){if(!raw)return‚Äôbaza tlenowa‚Äô;const s=raw.toLowerCase().trim();if(s.includes(‚Äòbaza‚Äô))return‚Äôbaza tlenowa‚Äô;if(s.includes(‚Äòzabawa‚Äô))return‚Äôzabawa biegowa‚Äô;if(s.includes(‚Äòprogowy‚Äô)||s.includes(‚Äòprog‚Äô))return‚Äôoko≈Ço progowy‚Äô;if(s.includes(‚ÄòciƒÖg≈Ç‚Äô)||s.includes(‚Äòciag≈Ç‚Äô)||s.includes(‚Äòciagly‚Äô)||s===‚ÄòciƒÖg≈Çy‚Äô)return‚ÄôciƒÖg≈Çy‚Äô;if(s.includes(‚Äòinterw‚Äô))return‚Äôinterwa≈Çowy‚Äô;if(s===‚Äòinny‚Äô)return‚Äôinny‚Äô;return s||‚Äòbaza tlenowa‚Äô;}

// ‚ïê‚ïê‚ïê SEED & MIGRATE ‚ïê‚ïê‚ïê
function seedData(){
if(loadTrainings().length>0)return;
saveTrainings([
{id:1738800000001,date:‚Äò2025-02-06‚Äô,activity:‚Äòbieg‚Äô,type:‚Äòbaza tlenowa‚Äô,rpe:6,distance:6.06,durationSeconds:2129,accent:0,hr:null,note:‚Äô‚Äô,commentExcl:false,zoneTimes:{},task:‚Äô‚Äô},
{id:1738800000002,date:‚Äò2025-02-07‚Äô,activity:‚Äòbieg‚Äô,type:‚Äòoko≈Ço progowy‚Äô,rpe:8,distance:8.05,durationSeconds:2717,accent:0,hr:145,note:‚Äô‚Äô,commentExcl:false,zoneTimes:{},task:‚Äô‚Äô},
]);
}
function migrateData(){
const t=loadTrainings();let c=false;
t.forEach(x=>{
if(x.durationSeconds==null&&x.duration!=null){x.durationSeconds=Math.round(x.duration*60);c=true;}
if(x.commentExcl==null){x.commentExcl=false;c=true;}
if(!x.zoneTimes){x.zoneTimes={};c=true;}
if(x.task==null){x.task=‚Äô‚Äô;c=true;}
if(x.hr===undefined){x.hr=null;c=true;}
const na=normaliseActivity(x.activity);if(na!==x.activity){x.activity=na;c=true;}
const nt=normaliseType(x.type);if(nt!==x.type){x.type=nt;c=true;}
if(‚ÄòcommentColor‚Äôin x){delete x.commentColor;c=true;}
});
if(c)saveTrainings(t);
const p=loadPlanned();let pc=false;
p.forEach(x=>{if(x.notes==null){x.notes=‚Äô‚Äô;pc=true;}});
if(pc)savePlanned(p);
}

// ‚ïê‚ïê‚ïê DATE HELPERS ‚ïê‚ïê‚ïê
function todayISO(){const n=new Date();return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;}

// Format: 26.02.26 (narrow)
function formatDatePL(iso){
if(!iso||iso===‚Äô‚Äô)return‚Äô‚Äî‚Äô;
const[y,m,d]=iso.split(‚Äô-‚Äô);
const yy=y.slice(2);
return`${d}.${m}.${yy}`;
}

function parseDatePL(s){if(!s||!s.trim())return null;const p=s.trim().split(‚Äô.‚Äô);if(p.length!==3)return null;const d=p[0].padStart(2,‚Äò0‚Äô),m=p[1].padStart(2,‚Äò0‚Äô),y=p[2];if(y.length!==4||isNaN(+y)||isNaN(+m)||isNaN(+d))return null;return`${y}-${m}-${d}`;}
function isoToLocal(iso){const[y,m,d]=iso.split(‚Äô-‚Äô).map(Number);return new Date(y,m-1,d);}
function localToISO(dt){return`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;}
function weekStart(dt){const d=new Date(dt);const day=d.getDay();const diff=day===0?-6:1-day;d.setDate(d.getDate()+diff);d.setHours(0,0,0,0);return d;}
function addDays(dt,n){const d=new Date(dt);d.setDate(d.getDate()+n);return d;}
function fmtShort(dt){return`${String(dt.getDate()).padStart(2,'0')}.${String(dt.getMonth()+1).padStart(2,'0')}`;}
function fmtShortY(dt){return`${String(dt.getDate()).padStart(2,'0')}.${String(dt.getMonth()+1).padStart(2,'0')}.${dt.getFullYear()}`;}
function getISOWeek(dt){const d=new Date(Date.UTC(dt.getFullYear(),dt.getMonth(),dt.getDate()));const day=d.getUTCDay()||7;d.setUTCDate(d.getUTCDate()+4-day);const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));return Math.ceil((((d-yearStart)/86400000)+1)/7);}
const MONTHS_PL=[‚ÄòSty‚Äô,‚ÄòLut‚Äô,‚ÄòMar‚Äô,‚ÄòKwi‚Äô,‚ÄòMaj‚Äô,‚ÄòCze‚Äô,‚ÄòLip‚Äô,‚ÄòSie‚Äô,‚ÄòWrz‚Äô,‚ÄòPa≈∫‚Äô,‚ÄòLis‚Äô,‚ÄòGru‚Äô];
const MONTHS_FULL_PL=[‚ÄòStycze≈Ñ‚Äô,‚ÄòLuty‚Äô,‚ÄòMarzec‚Äô,‚ÄòKwiecie≈Ñ‚Äô,‚ÄòMaj‚Äô,‚ÄòCzerwiec‚Äô,‚ÄòLipiec‚Äô,‚ÄòSierpie≈Ñ‚Äô,‚ÄòWrzesie≈Ñ‚Äô,‚ÄòPa≈∫dziernik‚Äô,‚ÄòListopad‚Äô,‚ÄòGrudzie≈Ñ‚Äô];
const DAYS_PL=[‚ÄòPon‚Äô,‚ÄòWto‚Äô,‚Äò≈öro‚Äô,‚ÄòCzw‚Äô,‚ÄòPiƒÖ‚Äô,‚ÄòSob‚Äô,‚ÄòNie‚Äô];

// ‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê
function switchTab(name){
document.querySelectorAll(‚Äô.tab-btn‚Äô).forEach(b=>b.classList.toggle(‚Äòactive‚Äô,b.dataset.tab===name));
document.querySelectorAll(‚Äô.tab-content‚Äô).forEach(c=>c.classList.remove(‚Äòactive‚Äô));
const el=document.getElementById(‚Äòtab-‚Äô+name);
el.classList.add(‚Äòactive‚Äô);el.classList.remove(‚Äòanimate-in‚Äô);void el.offsetWidth;el.classList.add(‚Äòanimate-in‚Äô);
if(name===‚Äòendurance‚Äô){renderEndurance();renderPlanned();}
if(name===‚Äòsummary‚Äô){renderSummary();}
}
function openHistory(){
document.querySelectorAll(‚Äô.tab-btn‚Äô).forEach(b=>b.classList.remove(‚Äòactive‚Äô));
document.querySelectorAll(‚Äô.tab-content‚Äô).forEach(c=>c.classList.remove(‚Äòactive‚Äô));
const el=document.getElementById(‚Äòtab-history‚Äô);
el.classList.add(‚Äòactive‚Äô);el.classList.remove(‚Äòanimate-in‚Äô);void el.offsetWidth;el.classList.add(‚Äòanimate-in‚Äô);
populateYearFilter();renderHistory();
}
document.querySelectorAll(‚Äô.tab-btn‚Äô).forEach(btn=>btn.addEventListener(‚Äòclick‚Äô,()=>switchTab(btn.dataset.tab)));

// ‚ïê‚ïê‚ïê MULTI-SELECT ‚ïê‚ïê‚ïê
function toggleMsDropdown(id){const wrap=document.getElementById(id);const trigger=wrap.querySelector(‚Äô.ms-trigger‚Äô);const dropdown=wrap.querySelector(‚Äô.ms-dropdown‚Äô);const isOpen=dropdown.classList.contains(‚Äòopen‚Äô);document.querySelectorAll(‚Äô.ms-dropdown.open‚Äô).forEach(d=>{d.classList.remove(‚Äòopen‚Äô);d.closest(‚Äô.ms-filter‚Äô).querySelector(‚Äô.ms-trigger‚Äô).classList.remove(‚Äòopen‚Äô);});if(!isOpen){dropdown.classList.add(‚Äòopen‚Äô);trigger.classList.add(‚Äòopen‚Äô);}}
document.addEventListener(‚Äòclick‚Äô,e=>{if(!e.target.closest(‚Äô.ms-filter‚Äô)){document.querySelectorAll(‚Äô.ms-dropdown.open‚Äô).forEach(d=>{d.classList.remove(‚Äòopen‚Äô);d.closest(‚Äô.ms-filter‚Äô).querySelector(‚Äô.ms-trigger‚Äô).classList.remove(‚Äòopen‚Äô);});}});
function msChanged(id){const wrap=document.getElementById(id);const checked=[‚Ä¶wrap.querySelectorAll(‚Äòinput[type=‚Äúcheckbox‚Äù]:checked‚Äô)];const badge=wrap.querySelector(‚Äô.ms-badge‚Äô),labelEl=wrap.querySelector(‚Äô.ms-label‚Äô);if(checked.length===0){badge.style.display=‚Äònone‚Äô;labelEl.textContent=‚ÄòWszystkie‚Äô;}else{badge.textContent=checked.length;badge.style.display=‚Äòinline-block‚Äô;labelEl.textContent=checked.length===1?checked[0].parentElement.textContent.trim():`${checked.length} wybrane`;}renderHistory();}
function clearMs(id){document.getElementById(id).querySelectorAll(‚Äòinput[type=‚Äúcheckbox‚Äù]‚Äô).forEach(cb=>cb.checked=false);msChanged(id);}
function getMsValues(id){return[‚Ä¶document.getElementById(id).querySelectorAll(‚Äòinput[type=‚Äúcheckbox‚Äù]:checked‚Äô)].map(cb=>cb.value);}
function clearAllFilters(){document.getElementById(‚Äòh-filter-year‚Äô).value=‚Äô‚Äô;document.getElementById(‚Äòh-filter-rpe‚Äô).value=‚Äô‚Äô;[‚Äòms-month‚Äô,‚Äòms-activity‚Äô,‚Äòms-type‚Äô].forEach(id=>clearMs(id));renderHistory();}

// ‚ïê‚ïê‚ïê PLAN MODAL ‚ïê‚ïê‚ïê
let editingPlanId=null;
function openPlanModal(){editingPlanId=null;document.getElementById(‚Äòpm-date‚Äô).value=‚Äô‚Äô;document.getElementById(‚Äòpm-type‚Äô).value=‚Äòbaza tlenowa‚Äô;document.getElementById(‚Äòpm-task‚Äô).value=‚Äô‚Äô;document.getElementById(‚Äòpm-notes‚Äô).value=‚Äô‚Äô;document.getElementById(‚Äòmodal-title-text‚Äô).textContent=‚ÄòüìÖ Zaplanuj trening‚Äô;document.getElementById(‚Äòpm-save-btn‚Äô).textContent=‚ÄòZapisz plan‚Äô;document.getElementById(‚Äòplan-modal‚Äô).classList.add(‚Äòopen‚Äô);}
function openPlanEditModal(id){const p=loadPlanned().find(x=>x.id===id);if(!p)return;editingPlanId=id;document.getElementById(‚Äòpm-date‚Äô).value=p.date||‚Äô‚Äô;document.getElementById(‚Äòpm-type‚Äô).value=p.type||‚Äòbaza tlenowa‚Äô;document.getElementById(‚Äòpm-task‚Äô).value=p.task||‚Äô‚Äô;document.getElementById(‚Äòpm-notes‚Äô).value=p.notes||‚Äô‚Äô;document.getElementById(‚Äòmodal-title-text‚Äô).textContent=‚Äò‚úèÔ∏è Edytuj plan‚Äô;document.getElementById(‚Äòpm-save-btn‚Äô).textContent=‚ÄòZapisz zmiany‚Äô;document.getElementById(‚Äòplan-modal‚Äô).classList.add(‚Äòopen‚Äô);}
function closePlanModal(){document.getElementById(‚Äòplan-modal‚Äô).classList.remove(‚Äòopen‚Äô);editingPlanId=null;}
function savePlan(){const date=document.getElementById(‚Äòpm-date‚Äô).value,type=document.getElementById(‚Äòpm-type‚Äô).value,task=document.getElementById(‚Äòpm-task‚Äô).value.trim(),notes=document.getElementById(‚Äòpm-notes‚Äô).value.trim(),plans=loadPlanned();if(editingPlanId!==null){const idx=plans.findIndex(x=>x.id===editingPlanId);if(idx!==-1)plans[idx]={‚Ä¶plans[idx],date,type,task,notes};}else plans.push({id:Date.now(),date,type,task,notes});savePlanned(plans);closePlanModal();renderPlanned();}

// ‚ïê‚ïê‚ïê PLANNED TABLE ‚ïê‚ïê‚ïê
let pendingPlanId=null;
function renderPlanned(){
const all=loadPlanned();const section=document.getElementById(‚Äòplanned-section‚Äô);
if(all.length===0){section.style.display=‚Äònone‚Äô;return;}
section.style.display=‚Äòblock‚Äô;document.getElementById(‚Äòplanned-count‚Äô).textContent=`(${all.length})`;
const display=[‚Ä¶all].sort((a,b)=>a.id-b.id).slice(0,5).reverse();
document.getElementById(‚Äòplanned-tbody‚Äô).innerHTML=display.map(p=>`<tr> <td class="mono" style="white-space:nowrap;">${p.date?formatDatePL(p.date):'‚Äî'}</td> <td><span class="tag-sm ${typeTagClass(p.type)}">${escHtml(p.type||'‚Äî')}</span></td> <td style="font-family:'DM Mono',monospace;font-size:0.72rem;max-width:150px;word-break:break-word;">${escHtml(p.task||'‚Äî')}</td> <td style="font-family:'DM Mono',monospace;font-size:0.72rem;max-width:160px;word-break:break-word;color:var(--muted);">${escHtml(p.notes||'‚Äî')}</td> <td style="white-space:nowrap;"> <button class="execute-btn" onclick="executePlan(${p.id})">Wykonany <span style="font-size:1rem;">‚úÖ</span></button> <button class="plan-row-btn" onclick="openPlanEditModal(${p.id})">Edytuj</button> <button class="plan-row-btn del" onclick="deletePlan(${p.id})">Usu≈Ñ</button> </td></tr>`).join(‚Äô‚Äô);
}
window.executePlan=function(id){const p=loadPlanned().find(x=>x.id===id);if(!p)return;pendingPlanId=id;document.getElementById(‚Äòf-type‚Äô).value=p.type||‚Äòbaza tlenowa‚Äô;if(p.date)document.getElementById(‚Äòf-date‚Äô).value=p.date;document.getElementById(‚Äòf-task‚Äô).value=p.task||‚Äô‚Äô;if(p.task&&!taskVisible)toggleTask();else if(!p.task&&taskVisible)toggleTask();document.getElementById(‚Äòplan-source-banner‚Äô).style.display=‚Äòflex‚Äô;switchTab(‚Äòendurance‚Äô);document.getElementById(‚Äòform-card‚Äô).scrollIntoView({behavior:‚Äòsmooth‚Äô,block:‚Äòstart‚Äô});};
window.deletePlan=function(id){if(!confirm(‚ÄòUsunƒÖƒá ten plan?‚Äô))return;if(pendingPlanId===id)clearPlanSource();savePlanned(loadPlanned().filter(x=>x.id!==id));renderPlanned();};
function clearPlanSource(){pendingPlanId=null;document.getElementById(‚Äòplan-source-banner‚Äô).style.display=‚Äònone‚Äô;}

// ‚ïê‚ïê‚ïê RPE ‚ïê‚ïê‚ïê
let selectedRPE=null;
function rpeStyle(n,sel){const p=RPE_PALETTE[n];if(sel)return`background:${p.bg};border-color:${p.border};border-width:2.5px;color:${p.text};`;return`background:var(--paper);border-color:var(--border);color:var(--muted);`;}
(function buildRPE(){const c=document.getElementById(‚Äòrpe-buttons‚Äô);for(let i=1;i<=10;i++){const b=document.createElement(‚Äòbutton‚Äô);b.className=‚Äòrpe-btn‚Äô;b.textContent=i;b.dataset.rpe=i;b.style.cssText=rpeStyle(i,false);b.addEventListener(‚Äòmouseenter‚Äô,()=>{if(selectedRPE!==i){const p=RPE_PALETTE[i];b.style.cssText=`background:${p.bg};border-color:${p.border};border-width:1.5px;color:${p.text};transform:scale(1.1);`;}});b.addEventListener(‚Äòmouseleave‚Äô,()=>{b.style.cssText=rpeStyle(i,selectedRPE===i);});b.addEventListener(‚Äòclick‚Äô,()=>{selectedRPE=selectedRPE===i?null:i;refreshRPE();});c.appendChild(b);}})();
function refreshRPE(){document.querySelectorAll(‚Äô.rpe-btn‚Äô).forEach(b=>{const n=parseInt(b.dataset.rpe);b.style.cssText=rpeStyle(n,n===selectedRPE);});}
function rpeDotStyle(rpe){if(!rpe)return{bg:‚Äô#e5e7eb‚Äô,border:‚Äô#d1d5db‚Äô,color:‚Äô#6b7280‚Äô};const p=RPE_PALETTE[rpe];return{bg:p.bg,border:p.border,color:p.text};}

// ‚ïê‚ïê‚ïê TOGGLES ‚ïê‚ïê‚ïê
let taskVisible=false;
function toggleTask(){taskVisible=!taskVisible;document.getElementById(‚Äòtask-field‚Äô).style.display=taskVisible?‚Äòblock‚Äô:‚Äònone‚Äô;document.getElementById(‚Äòtask-toggle-btn‚Äô).classList.toggle(‚Äòactive-panel‚Äô,taskVisible);}
let zoneTimeVisible=false;
function toggleZoneTime(){zoneTimeVisible=!zoneTimeVisible;document.getElementById(‚Äòzone-time-fields‚Äô).style.display=zoneTimeVisible?‚Äòblock‚Äô:‚Äònone‚Äô;document.getElementById(‚Äòzone-time-toggle-btn‚Äô).classList.toggle(‚Äòactive-panel‚Äô,zoneTimeVisible);}
let zoneColExpanded=false;
function toggleZoneCol(){zoneColExpanded=!zoneColExpanded;const btn=document.getElementById(‚Äòzone-col-btn‚Äô);if(btn)btn.textContent=zoneColExpanded?‚Äò‚àí‚Äô:‚Äô+‚Äô;document.querySelectorAll(‚Äô.zone-col-th‚Äô).forEach(th=>th.style.width=zoneColExpanded?‚Äòauto‚Äô:‚Äò2.2rem‚Äô);document.querySelectorAll(‚Äô.zone-col-td‚Äô).forEach(td=>{td.style.maxWidth=zoneColExpanded?‚Äò300px‚Äô:‚Äò0‚Äô;td.style.overflow=zoneColExpanded?‚Äòvisible‚Äô:‚Äòhidden‚Äô;td.style.padding=zoneColExpanded?‚Äò0.5rem 0.65rem‚Äô:‚Äò0.5rem 0‚Äô;});document.querySelectorAll(‚Äô.zone-col-content‚Äô).forEach(el=>el.style.display=zoneColExpanded?‚Äòblock‚Äô:‚Äònone‚Äô);}
let commentExcl=false;
function toggleExcl(){commentExcl=!commentExcl;document.getElementById(‚Äòexcl-btn‚Äô).classList.toggle(‚Äòon‚Äô,commentExcl);}
function resetExcl(){commentExcl=false;document.getElementById(‚Äòexcl-btn‚Äô).classList.remove(‚Äòon‚Äô);}

// ‚ïê‚ïê‚ïê TIME & PACE ‚ïê‚ïê‚ïê
function parseTime(str){if(!str||!str.trim())return null;const parts=str.trim().split(‚Äô:‚Äô);if(parts.length===2){const m=parseInt(parts[0],10),s=parseInt(parts[1],10);if(isNaN(m)||isNaN(s)||s<0||s>59)return null;return m*60+s;}if(parts.length===3){const h=parseInt(parts[0],10),m=parseInt(parts[1],10),s=parseInt(parts[2],10);if(isNaN(h)||isNaN(m)||isNaN(s)||m>59||s>59)return null;return h*3600+m*60+s;}return null;}
function formatDuration(sec){if(!sec||sec<=0)return‚Äô‚Äî‚Äô;const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60;if(h>0)return`${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;return`${m}:${String(s).padStart(2,'0')}`;}
function calcPaceStr(d,s){if(!d||!s||d<=0||s<=0)return null;const ps=s/d,pm=Math.floor(ps/60),ss=Math.round(ps%60);return ss===60?`${pm+1}:00`:`${pm}:${String(ss).padStart(2,'0')}`;}
const distInp=document.getElementById(‚Äòf-distance‚Äô),durInp=document.getElementById(‚Äòf-duration‚Äô),paceInp=document.getElementById(‚Äòf-pace‚Äô);
function updatePaceLive(){const p=calcPaceStr(parseFloat(distInp.value),parseTime(durInp.value));paceInp.value=p?p+‚Äô min/km‚Äô:‚Äô‚Äô;}
distInp.addEventListener(‚Äòinput‚Äô,updatePaceLive);durInp.addEventListener(‚Äòinput‚Äô,updatePaceLive);
durInp.addEventListener(‚Äòblur‚Äô,()=>{const r=durInp.value.trim();if(/^\d{3,4}$/.test(r)){durInp.value=`${r.slice(0,r.length-2)}:${r.slice(-2)}`;updatePaceLive();}});
[1,2,3,4,5].forEach(z=>{document.getElementById(`zt-${z}`).addEventListener(‚Äòblur‚Äô,()=>{const i=document.getElementById(`zt-${z}`),r=i.value.trim();if(/^\d{3,4}$/.test(r))i.value=`${r.slice(0,r.length-2)}:${r.slice(-2)}`;});});
document.getElementById(‚Äòf-date‚Äô).value=todayISO();

// ‚ïê‚ïê‚ïê EDIT STATE ‚ïê‚ïê‚ïê
let editingId=null;
function enterEditMode(id){
const t=loadTrainings().find(x=>x.id===id);if(!t)return;
editingId=id;
document.getElementById(‚Äòf-date‚Äô).value=t.date||todayISO();document.getElementById(‚Äòf-activity‚Äô).value=t.activity||‚Äòbieg‚Äô;document.getElementById(‚Äòf-type‚Äô).value=t.type||‚Äòbaza tlenowa‚Äô;
distInp.value=t.distance||‚Äô‚Äô;const ds=formatDuration(t.durationSeconds);durInp.value=ds!==‚Äô‚Äî‚Äô?ds:‚Äô‚Äô;
document.getElementById(‚Äòf-accent‚Äô).value=t.accent||‚Äô‚Äô;document.getElementById(‚Äòf-note‚Äô).value=t.note||‚Äô‚Äô;document.getElementById(‚Äòf-task‚Äô).value=t.task||‚Äô‚Äô;document.getElementById(‚Äòf-hr‚Äô).value=t.hr||‚Äô‚Äô;
const tv=t.task||‚Äô‚Äô;if(tv&&!taskVisible)toggleTask();else if(!tv&&taskVisible)toggleTask();
commentExcl=!!t.commentExcl;document.getElementById(‚Äòexcl-btn‚Äô).classList.toggle(‚Äòon‚Äô,commentExcl);
selectedRPE=t.rpe||null;refreshRPE();updatePaceLive();
const zt=t.zoneTimes||{};[1,2,3,4,5].forEach(z=>{const v=zt[z]?formatDuration(zt[z]):‚Äô‚Äô;document.getElementById(`zt-${z}`).value=v!==‚Äô‚Äî‚Äô?v:‚Äô‚Äô;});
const hz=Object.values(zt).some(v=>v>0);if(hz&&!zoneTimeVisible)toggleZoneTime();else if(!hz&&zoneTimeVisible)toggleZoneTime();
document.getElementById(‚Äòadd-btn‚Äô).textContent=‚Äòüíæ Zapisz zmiany‚Äô;document.getElementById(‚Äòcancel-btn‚Äô).style.display=‚Äòinline-block‚Äô;
document.getElementById(‚Äòedit-banner‚Äô).classList.add(‚Äòvisible‚Äô);document.getElementById(‚Äòform-card‚Äô).classList.add(‚Äòediting‚Äô);
clearPlanSource();switchTab(‚Äòendurance‚Äô);document.getElementById(‚Äòform-card‚Äô).scrollIntoView({behavior:‚Äòsmooth‚Äô,block:‚Äòstart‚Äô});
}
function cancelEdit(){editingId=null;resetForm();}
function resetForm(){
editingId=null;document.getElementById(‚Äòf-date‚Äô).value=todayISO();document.getElementById(‚Äòf-activity‚Äô).value=‚Äòbieg‚Äô;document.getElementById(‚Äòf-type‚Äô).value=‚Äòbaza tlenowa‚Äô;
distInp.value=‚Äô‚Äô;durInp.value=‚Äô‚Äô;document.getElementById(‚Äòf-accent‚Äô).value=‚Äô‚Äô;document.getElementById(‚Äòf-note‚Äô).value=‚Äô‚Äô;document.getElementById(‚Äòf-task‚Äô).value=‚Äô‚Äô;document.getElementById(‚Äòf-hr‚Äô).value=‚Äô‚Äô;
selectedRPE=null;refreshRPE();paceInp.value=‚Äô‚Äô;resetExcl();
[1,2,3,4,5].forEach(z=>document.getElementById(`zt-${z}`).value=‚Äô‚Äô);
if(taskVisible)toggleTask();if(zoneTimeVisible)toggleZoneTime();
document.getElementById(‚Äòadd-btn‚Äô).textContent=‚Äô+ Dodaj trening‚Äô;document.getElementById(‚Äòcancel-btn‚Äô).style.display=‚Äònone‚Äô;
document.getElementById(‚Äòedit-banner‚Äô).classList.remove(‚Äòvisible‚Äô);document.getElementById(‚Äòform-card‚Äô).classList.remove(‚Äòediting‚Äô);
document.getElementById(‚Äòform-error‚Äô).style.display=‚Äònone‚Äô;clearPlanSource();renderEndurance();
}

// ‚ïê‚ïê‚ïê ADD / SAVE ‚ïê‚ïê‚ïê
document.getElementById(‚Äòadd-btn‚Äô).addEventListener(‚Äòclick‚Äô,()=>{
const date=document.getElementById(‚Äòf-date‚Äô).value,activity=document.getElementById(‚Äòf-activity‚Äô).value,type=document.getElementById(‚Äòf-type‚Äô).value;
const distance=parseFloat(distInp.value),durationSeconds=parseTime(durInp.value),accent=parseFloat(document.getElementById(‚Äòf-accent‚Äô).value)||0;
const note=document.getElementById(‚Äòf-note‚Äô).value.trim(),task=document.getElementById(‚Äòf-task‚Äô).value.trim();
const hrRaw=parseInt(document.getElementById(‚Äòf-hr‚Äô).value),hr=isNaN(hrRaw)||hrRaw<=0?null:hrRaw;
if(!date){showError(‚ÄòPodaj datƒô.‚Äô);return;}if(!distance||distance<=0){showError(‚ÄòPodaj dystans.‚Äô);return;}if(!durationSeconds||durationSeconds<=0){showError(‚ÄòPodaj czas.‚Äô);return;}
document.getElementById(‚Äòform-error‚Äô).style.display=‚Äònone‚Äô;
const zoneTimes={};[1,2,3,4,5].forEach(z=>{const s=parseTime(document.getElementById(`zt-${z}`).value);if(s&&s>0)zoneTimes[z]=s;});
const record={date,activity,type,distance,durationSeconds,accent,rpe:selectedRPE,hr,note,commentExcl,zoneTimes,task};
const all=loadTrainings();
if(editingId!==null){const idx=all.findIndex(x=>x.id===editingId);if(idx!==-1)all[idx]={‚Ä¶all[idx],‚Ä¶record};}else all.push({id:Date.now(),‚Ä¶record});
saveTrainings(all);if(pendingPlanId!==null){savePlanned(loadPlanned().filter(x=>x.id!==pendingPlanId));pendingPlanId=null;}resetForm();
});
function showError(msg){const el=document.getElementById(‚Äòform-error‚Äô);el.textContent=msg;el.style.display=‚Äòinline‚Äô;setTimeout(()=>el.style.display=‚Äònone‚Äô,4000);}

// ‚ïê‚ïê‚ïê DELETE / EDIT ‚ïê‚ïê‚ïê
window.deleteTraining=function(id){if(!confirm(‚ÄòUsunƒÖƒá ten trening?‚Äô))return;if(editingId===id)cancelEdit();saveTrainings(loadTrainings().filter(x=>x.id!==id));renderEndurance();if(document.getElementById(‚Äòtab-history‚Äô).classList.contains(‚Äòactive‚Äô))renderHistory();};
window.editTraining=function(id){enterEditMode(id);};

// ‚ïê‚ïê‚ïê DISPLAY HELPERS ‚ïê‚ïê‚ïê
function escHtml(s){return(s||‚Äô‚Äô).replace(/&/g,‚Äô&‚Äô).replace(/</g,‚Äô<‚Äô).replace(/>/g,‚Äô>‚Äô).replace(/‚Äù/g,‚Äô"‚Äô);}
function typeTagClass(type){const t=(type||‚Äô‚Äô).toLowerCase();if(t===‚Äòbaza tlenowa‚Äô)return‚Äôtag-type-blue‚Äô;if(t===‚Äòinterwa≈Çowy‚Äô||t===‚Äòoko≈Ço progowy‚Äô)return‚Äôtag-type-orange‚Äô;return‚Äôtag-type-green‚Äô;}

// Komentarz jako inline tekst (bez tooltip)
function commentCellHTML(note,excl){
if(!note||!note.trim())return`<div class="comment-cell-inline empty">‚Äî</div>`;
if(excl)return`<div class="comment-cell-inline excl">‚ùó ${escHtml(note)}</div>`;
return`<div class="comment-cell-inline">${escHtml(note)}</div>`;
}

function zoneTimesHTML(zt){const p=[];for(let z=1;z<=5;z++){const s=zt&&zt[z]?zt[z]:0;p.push(`<span>S${z}-${s>0?formatDuration(s):'00:00'}</span>`);}return`<div class="zone-time-cell">${p.join('')}</div>`;}
function hrCellHTML(hr){if(!hr)return`<span style="color:var(--border);">‚Äî</span>`;return`<span class="hr-cell">‚ô• ${hr}</span>`;}

// ‚ïê‚ïê‚ïê BUILD TABLE ‚ïê‚ïê‚ïê
function buildTableHTML(rows,mode){
const sortable=mode===‚Äòfull‚Äô;
if(rows.length===0)return`<div class="empty-state"><div class="big">üèÉ</div><p class="font-semibold" style="color:var(--muted);">Brak trening√≥w</p></div>`;

// Compact: Data | Akt. | Typ | Zadanie | Kom. | RPE | Dystans | Czas | Tempo | Tƒôtno | Akcje
const compactCols=[
{key:‚Äòdate‚Äô,label:‚ÄòData‚Äô},
{key:‚Äòactivity‚Äô,label:‚ÄòAkt.‚Äô},
{key:‚Äòtype‚Äô,label:‚ÄòTyp‚Äô},
{key:‚Äô‚Äô,label:‚ÄòZadanie‚Äô,taskCol:true},
{key:‚Äô‚Äô,label:‚ÄòKom.‚Äô,commentCol:true},
{key:‚Äòrpe‚Äô,label:‚ÄòRPE‚Äô},
{key:‚Äòdistance‚Äô,label:‚ÄòDystans‚Äô},
{key:‚Äòtime‚Äô,label:‚ÄòCzas‚Äô},
{key:‚Äòpace‚Äô,label:‚ÄòTempo‚Äô},
{key:‚Äô‚Äô,label:‚ÄòTƒôtno‚Äô},
{key:‚Äô‚Äô,label:‚Äô‚Äô}
];
// Full (historia): Data | Akt. | Typ | Zadanie | Kom. | RPE | Dystans | Czas | Tempo | Tƒôtno | Strefy | Akcje
const fullCols=[
{key:‚Äòdate‚Äô,label:‚ÄòData‚Äô},
{key:‚Äòactivity‚Äô,label:‚ÄòAkt.‚Äô},
{key:‚Äòtype‚Äô,label:‚ÄòTyp‚Äô},
{key:‚Äô‚Äô,label:‚ÄòZadanie‚Äô,taskCol:true},
{key:‚Äô‚Äô,label:‚ÄòKom.‚Äô,commentCol:true},
{key:‚Äòrpe‚Äô,label:‚ÄòRPE‚Äô},
{key:‚Äòdistance‚Äô,label:‚ÄòDystans‚Äô},
{key:‚Äòtime‚Äô,label:‚ÄòCzas‚Äô},
{key:‚Äòpace‚Äô,label:‚ÄòTempo‚Äô},
{key:‚Äô‚Äô,label:‚ÄòTƒôtno‚Äô},
{key:‚Äô‚Äô,label:‚ÄòStrefy‚Äô,zoneCol:true},
{key:‚Äô‚Äô,label:‚Äô‚Äô}
];
const cols=mode===‚Äòcompact‚Äô?compactCols:fullCols;

const thead=`<table class="data-table"><thead><tr>`+cols.map(h=>{
if(h.zoneCol)return`<th class="zone-col-th" style="width:2.2rem;text-align:center;">Strefy<button class="zone-toggle-btn" id="zone-col-btn" onclick="toggleZoneCol()" title="Poka≈º/ukryj">+</button></th>`;
if(h.taskCol||h.commentCol)return`<th style="min-width:90px;max-width:150px;">${h.label}</th>`;
if(!h.key||!sortable)return`<th>${h.label}</th>`;
const cls=hSortCol===h.key?(hSortDir===‚Äòasc‚Äô?‚Äòsort-asc‚Äô:‚Äòsort-desc‚Äô):‚Äô‚Äô;
return`<th data-col="${h.key}" class="sortable ${cls}">${h.label}<span class="sort-icon"></span></th>`;
}).join(‚Äô‚Äô)+`</tr></thead><tbody>`;

const tbody=rows.map(t=>{
const pace=calcPaceStr(t.distance,t.durationSeconds),dur=formatDuration(t.durationSeconds),dot=rpeDotStyle(t.rpe);
const rpeCell=t.rpe?`<span class="rpe-dot" style="background:${dot.bg};color:${dot.color};border:1.5px solid ${dot.border};">${t.rpe}</span>`:`<span style="color:var(--border);">‚Äî</span>`;
const taskHTML=t.task?`<div class="task-cell">${escHtml(t.task)}</div>`:`<div class="task-cell empty">‚Äî</div>`;
const commentHTML=commentCellHTML(t.note,t.commentExcl);

```
if(mode==='compact'){
  return`<tr>
    <td><span class="date-cell">${formatDatePL(t.date)}</span></td>
    <td><span class="tag-sm tag-activity">${escHtml(t.activity||'‚Äî')}</span></td>
    <td><span class="tag-sm ${typeTagClass(t.type)}">${escHtml(t.type||'‚Äî')}</span></td>
    <td style="min-width:90px;max-width:150px;">${taskHTML}</td>
    <td style="min-width:90px;max-width:150px;">${commentHTML}</td>
    <td>${rpeCell}</td>
    <td class="mono" style="font-size:0.78rem;">${t.distance} km</td>
    <td class="mono" style="font-size:0.78rem;">${dur}</td>
    <td class="mono" style="font-size:0.78rem;">${pace?pace+' /km':'‚Äî'}</td>
    <td>${hrCellHTML(t.hr)}</td>
    <td style="white-space:nowrap;"><button class="row-btn" onclick="editTraining(${t.id})">Edytuj</button><button class="row-btn del" onclick="deleteTraining(${t.id})">Usu≈Ñ</button></td>
  </tr>`;
}

const col=!zoneColExpanded;
return`<tr>
  <td><span class="date-cell">${formatDatePL(t.date)}</span></td>
  <td><span class="tag-sm tag-activity">${escHtml(t.activity||'‚Äî')}</span></td>
  <td><span class="tag-sm ${typeTagClass(t.type)}">${escHtml(t.type||'‚Äî')}</span></td>
  <td style="min-width:90px;max-width:150px;">${taskHTML}</td>
  <td style="min-width:90px;max-width:150px;">${commentHTML}</td>
  <td>${rpeCell}</td>
  <td class="mono" style="font-size:0.78rem;">${t.distance} km</td>
  <td class="mono" style="font-size:0.78rem;">${dur}</td>
  <td class="mono" style="font-size:0.78rem;">${pace?pace+' /km':'‚Äî'}</td>
  <td>${hrCellHTML(t.hr)}</td>
  <td class="zone-col-td" style="max-width:${col?'0':'300px'};overflow:${col?'hidden':'visible'};padding:${col?'0.5rem 0':'0.5rem 0.65rem'};"><div class="zone-col-content" style="display:${col?'none':'block'};">${zoneTimesHTML(t.zoneTimes)}</div></td>
  <td style="white-space:nowrap;"><button class="row-btn" onclick="editTraining(${t.id})">Edytuj</button><button class="row-btn del" onclick="deleteTraining(${t.id})">Usu≈Ñ</button></td>
</tr>`;
```

}).join(‚Äô‚Äô);

return thead+tbody+‚Äô</tbody></table>‚Äô;
}

function renderEndurance(){const sorted=loadTrainings().sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id).slice(0,5);document.getElementById(‚Äòendurance-table-body‚Äô).innerHTML=buildTableHTML(sorted,‚Äòcompact‚Äô);}

// ‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê
let hSortCol=‚Äòdate‚Äô,hSortDir=‚Äòdesc‚Äô;
function populateYearFilter(){const sel=document.getElementById(‚Äòh-filter-year‚Äô),cur=sel.value;const years=[‚Ä¶new Set(loadTrainings().map(t=>t.date.split(‚Äô-‚Äô)[0]))].sort((a,b)=>b-a);sel.innerHTML=‚Äô<option value="">Wszystkie</option>‚Äô+years.map(y=>`<option value="${y}"${y===cur?' selected':''}>${y}</option>`).join(‚Äô‚Äô);}
function renderHistory(){
let data=loadTrainings();const fy=document.getElementById(‚Äòh-filter-year‚Äô).value,fr=document.getElementById(‚Äòh-filter-rpe‚Äô).value;
const months=getMsValues(‚Äòms-month‚Äô),activities=getMsValues(‚Äòms-activity‚Äô),types=getMsValues(‚Äòms-type‚Äô);
if(fy)data=data.filter(t=>t.date.startsWith(fy));if(months.length>0)data=data.filter(t=>months.includes(t.date.split(‚Äô-‚Äô)[1]));if(activities.length>0)data=data.filter(t=>activities.includes(t.activity));if(types.length>0)data=data.filter(t=>types.includes(t.type));if(fr)data=data.filter(t=>String(t.rpe)===fr);
data.sort((a,b)=>{let va,vb;switch(hSortCol){case‚Äôdate‚Äô:va=a.date;vb=b.date;break;case‚Äôactivity‚Äô:va=a.activity||‚Äô‚Äô;vb=b.activity||‚Äô‚Äô;break;case‚Äôtype‚Äô:va=a.type||‚Äô‚Äô;vb=b.type||‚Äô‚Äô;break;case‚Äôrpe‚Äô:va=a.rpe||0;vb=b.rpe||0;break;case‚Äôdistance‚Äô:va=a.distance||0;vb=b.distance||0;break;case‚Äôtime‚Äô:va=a.durationSeconds||0;vb=b.durationSeconds||0;break;case‚Äôpace‚Äô:va=(a.distance&&a.durationSeconds)?a.durationSeconds/a.distance:0;vb=(b.distance&&b.durationSeconds)?b.durationSeconds/b.distance:0;break;default:va=a.date;vb=b.date;}if(va<vb)return hSortDir===‚Äòasc‚Äô?-1:1;if(va>vb)return hSortDir===‚Äòasc‚Äô?1:-1;return 0;});
const wrap=document.getElementById(‚Äòhistory-table-body‚Äô);wrap.innerHTML=buildTableHTML(data,‚Äòfull‚Äô);
wrap.querySelectorAll(‚Äòth[data-col]‚Äô).forEach(th=>{th.addEventListener(‚Äòclick‚Äô,()=>{const col=th.dataset.col;if(hSortCol===col)hSortDir=hSortDir===‚Äòasc‚Äô?‚Äòdesc‚Äô:‚Äòasc‚Äô;else{hSortCol=col;hSortDir=‚Äòasc‚Äô;}renderHistory();});});
}

// ‚ïê‚ïê‚ïê CSV IMPORT ‚ïê‚ïê‚ïê
function handleCsvImport(event){const file=event.target.files[0];if(!file)return;readFileWithEncodingDetection(file).then(({text,encoding})=>{const log=document.getElementById(‚Äòimport-log‚Äô);log.style.display=‚Äòblock‚Äô;log.innerHTML=`<div style="color:#93c5fd;">üìÑ Wykryte kodowanie: ${encoding}</div>`;parseCsv(text);}).catch(err=>{const log=document.getElementById(‚Äòimport-log‚Äô);log.style.display=‚Äòblock‚Äô;log.innerHTML=`<div style="color:#fca5a5;">‚úó ${err.message}</div>`;});event.target.value=‚Äô‚Äô;}
function parseCsv(text){
const log=document.getElementById(‚Äòimport-log‚Äô);const logLine=(msg,ok=true)=>{log.innerHTML+=`<div style="color:${ok?'#86efac':'#fca5a5'};">${escHtml(msg)}</div>`;log.scrollTop=log.scrollHeight;};
const lines=text.replace(/\r\n/g,‚Äô\n‚Äô).replace(/\r/g,‚Äô\n‚Äô).split(‚Äô\n‚Äô).filter(l=>l.trim()!==‚Äô‚Äô);if(lines.length===0){logLine(‚ÄòPlik jest pusty.‚Äô,false);return;}
let startRow=0;const firstCols=lines[0].split(‚Äô;‚Äô);if(!parseDatePL((firstCols[0]||‚Äô‚Äô).trim())){logLine(`Pominiƒôto nag≈Ç√≥wek: "${lines[0].substring(0,60)}"`);startRow=1;}
const existing=loadTrainings();const imported=[];let ok=0,skipped=0,errors=0;
for(let i=startRow;i<lines.length;i++){
const raw=lines[i];if(!raw.trim())continue;const cols=splitCsvLine(raw,‚Äô;‚Äô);const c=(idx)=>(cols[idx]||‚Äô‚Äô).trim();
const date=parseDatePL(c(0));if(!date){logLine(`Wiersz ${i+1}: nieprawid≈Çowa data "${c(0)}" ‚Äî pomijam.`,false);errors++;continue;}
const activity=normaliseActivity(c(1)),type=normaliseType(c(2)),distance=parseFloat(c(3).replace(‚Äô,‚Äô,‚Äô.‚Äô));
if(isNaN(distance)||distance<=0){logLine(`Wiersz ${i+1}: nieprawid≈Çowy dystans "${c(3)}" ‚Äî pomijam.`,false);errors++;continue;}
const accent=parseFloat(c(4).replace(‚Äô,‚Äô,‚Äô.‚Äô))||0,durationSeconds=parseTime(c(5));
if(!durationSeconds||durationSeconds<=0){logLine(`Wiersz ${i+1}: nieprawid≈Çowy czas "${c(5)}" ‚Äî pomijam.`,false);errors++;continue;}
const rpeRaw=parseInt(c(6),10),rpe=(isNaN(rpeRaw)||rpeRaw<1||rpeRaw>10)?null:rpeRaw;
const task=c(7),note=c(8),commentExcl=false,hrRaw=parseInt(c(9),10),hr=(isNaN(hrRaw)||hrRaw<=0)?null:hrRaw;
const zoneTimes={};for(let z=0;z<5;z++){const secs=parseTime(c(10+z));if(secs&&secs>0)zoneTimes[z+1]=secs;}
const isDup=existing.some(x=>x.date===date&&x.distance===distance&&x.durationSeconds===durationSeconds);
if(isDup){logLine(`Wiersz ${i+1}: duplikat (${formatDatePL(date)}, ${distance} km) ‚Äî pomijam.`);skipped++;continue;}
imported.push({id:Date.now()+i,date,activity,type,distance,durationSeconds,accent,rpe,hr,note,commentExcl,zoneTimes,task});ok++;
}
if(imported.length>0){saveTrainings([‚Ä¶existing,‚Ä¶imported]);renderEndurance();if(document.getElementById(‚Äòtab-history‚Äô).classList.contains(‚Äòactive‚Äô)){populateYearFilter();renderHistory();}}
logLine(‚Äò‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Äô);logLine(`‚úì Zaimportowano: ${ok} trening√≥w`);if(skipped>0)logLine(`‚ö† Pominiƒôto duplikat√≥w: ${skipped}`);if(errors>0)logLine(`‚úó B≈Çƒôdy parsowania: ${errors}`,false);logLine(`≈ÅƒÖcznie wierszy danych: ${ok+skipped+errors}`);
}
function splitCsvLine(line,sep){const result=[];let cur=‚Äô‚Äô,inQ=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch===‚Äô‚Äù‚Äô){if(inQ&&line[i+1]===‚Äô‚Äù‚Äô){cur+=‚Äô‚Äù‚Äô;i++;}else inQ=!inQ;}else if(ch===sep&&!inQ){result.push(cur);cur=‚Äô‚Äô;}else{cur+=ch;}}result.push(cur);return result;}
function downloadSampleCsv(){const rows=[‚ÄòData;Aktywno≈õƒá;Typ;Dystans;Akcent;Czas;RPE;Zadanie;Notatka;Tƒôtno;S1;S2;S3;S4;S5‚Äô,‚Äò06.02.2025;bieg;baza tlenowa;6,06;0;35:29;6;spokojny bieg;dobre samopoczucie;138;15:00;12:00;6:00;2:00;0:29‚Äô,‚Äò07.02.2025;stadion;interwa≈Çowy;8,05;3;45:17;8;3x2000m;ciƒô≈ºki trening;162;5:00;8:00;20:00;10:00;2:17‚Äô];const bom=‚Äô\uFEFF‚Äô;const blob=new Blob([bom+rows.join(‚Äô\n‚Äô)],{type:‚Äòtext/csv;charset=utf-8;‚Äô});const url=URL.createObjectURL(blob);const a=document.createElement(‚Äòa‚Äô);a.href=url;a.download=‚Äòtrainlog_sample.csv‚Äô;a.click();URL.revokeObjectURL(url);}
function clearAllTrainings(){if(!confirm(‚ÄòUsunƒÖƒá WSZYSTKIE treningi?‚Äô))return;saveTrainings([]);renderEndurance();const log=document.getElementById(‚Äòimport-log‚Äô);log.style.display=‚Äòblock‚Äô;log.innerHTML=`<div style="color:#fca5a5;">üóë Wszystkie treningi zosta≈Çy usuniƒôte.</div>`;}

// ‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê
function buildZoneTable(){const tbody=document.getElementById(‚Äòzone-tbody‚Äô);tbody.innerHTML=‚Äô‚Äô;ZONE_DISPLAY.forEach(({num,label,cls})=>{const tr=document.createElement(‚Äòtr‚Äô);tr.innerHTML=`<td><span class="${cls}">${label}</span></td><td><input type="number" id="z${num}-bpm-min" placeholder="‚Äî" min="0" oninput="validateZones()"/></td><td><input type="number" id="z${num}-bpm-max" placeholder="‚Äî" min="0" oninput="validateZones()"/></td><td><input type="text" id="z${num}-pace-min" placeholder="5:00"/></td><td><input type="text" id="z${num}-pace-max" placeholder="6:30"/></td><td><input type="number" id="z${num}-power-min" placeholder="‚Äî" min="0" oninput="validateZones()"/></td><td><input type="number" id="z${num}-power-max" placeholder="‚Äî" min="0" oninput="validateZones()"/></td>`;tbody.appendChild(tr);});}
function validateZones(){let v=true;for(let z=1;z<=4;z++){const bm=parseInt(document.getElementById(`z${z}-bpm-max`).value)||0,bm2=parseInt(document.getElementById(`z${z+1}-bpm-min`).value)||0,pm=parseInt(document.getElementById(`z${z}-power-max`).value)||0,pm2=parseInt(document.getElementById(`z${z+1}-power-min`).value)||0;if((bm>0&&bm2>0&&bm2<=bm)||(pm>0&&pm2>0&&pm2<=pm)){v=false;break;}}document.getElementById(‚Äòzone-error‚Äô).style.display=v?‚Äònone‚Äô:‚Äòblock‚Äô;return v;}
function saveProfile(){if(!validateZones())return;const p={height:document.getElementById(‚Äòp-height‚Äô).value,weight:document.getElementById(‚Äòp-weight‚Äô).value,zones:{}};for(let z=1;z<=5;z++){p.zones[z]={bpmMin:document.getElementById(`z${z}-bpm-min`).value,bpmMax:document.getElementById(`z${z}-bpm-max`).value,powerMin:document.getElementById(`z${z}-power-min`).value,powerMax:document.getElementById(`z${z}-power-max`).value,paceMin:document.getElementById(`z${z}-pace-min`).value,paceMax:document.getElementById(`z${z}-pace-max`).value};}saveProfileData(p);const el=document.getElementById(‚Äòprofile-saved‚Äô);el.style.display=‚Äòinline‚Äô;setTimeout(()=>el.style.display=‚Äònone‚Äô,2500);}
function loadProfileUI(){const p=loadProfile();if(p.height)document.getElementById(‚Äòp-height‚Äô).value=p.height;if(p.weight)document.getElementById(‚Äòp-weight‚Äô).value=p.weight;if(p.zones){for(let z=1;z<=5;z++){const zd=p.zones[z];if(!zd)continue;document.getElementById(`z${z}-bpm-min`).value=zd.bpmMin||‚Äô‚Äô;document.getElementById(`z${z}-bpm-max`).value=zd.bpmMax||‚Äô‚Äô;document.getElementById(`z${z}-power-min`).value=zd.powerMin||‚Äô‚Äô;document.getElementById(`z${z}-power-max`).value=zd.powerMax||‚Äô‚Äô;document.getElementById(`z${z}-pace-min`).value=zd.paceMin||‚Äô‚Äô;document.getElementById(`z${z}-pace-max`).value=zd.paceMax||‚Äô‚Äô;}}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CZƒò≈öƒÜ 4: LOGIKA CHART.JS
// Wykres overlapping bars (grouped:false)
// S≈Çupek Akcentu asymetrycznie wysuniƒôty W PRAWO poza g≈Ç√≥wny s≈Çupek
// Technika: grouped:false + r√≥≈ºne barPercentage + niestandardowy plugin
// do rƒôcznego przesuniƒôcia s≈Çupka Akcent w prawo.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let summaryRange=‚Äòweek‚Äô, summaryOffset=0, summaryChart=null;

function today0(){const d=new Date();d.setHours(0,0,0,0);return d;}

function buildPeriod(off){
if(off===undefined)off=summaryOffset;
const now=today0();
if(summaryRange===‚Äòweek‚Äô){const mon=weekStart(now);const start=addDays(mon,off*7);return{start,end:addDays(start,6)};}
if(summaryRange===‚Äòmonth‚Äô){const base=new Date(now.getFullYear(),now.getMonth()+off,1);return{start:base,end:new Date(base.getFullYear(),base.getMonth()+1,0)};}
if(summaryRange===‚Äò12weeks‚Äô){
const lastMon=addDays(weekStart(now),off*12*7);
const end=addDays(lastMon,6);
const start=addDays(lastMon,-11*7);
return{start,end};
}
const y=now.getFullYear()+off;return{start:new Date(y,0,1),end:new Date(y,11,31)};
}

function aggregateForPeriod(){
const trainings=loadTrainings();
const{start,end}=buildPeriod();
const startISO=localToISO(start),endISO=localToISO(end);
const inRange=trainings.filter(t=>t.date>=startISO&&t.date<=endISO);
let labels=[],total=[],accent=[],weekRanges=[];

if(summaryRange===‚Äòweek‚Äô){
labels=DAYS_PL.slice();total=Array(7).fill(0);accent=Array(7).fill(0);
inRange.forEach(t=>{const dt=isoToLocal(t.date);const dow=dt.getDay();const idx=dow===0?6:dow-1;total[idx]+=(t.distance||0);accent[idx]+=(t.accent||0);});
} else if(summaryRange===‚Äòmonth‚Äô){
const dim=end.getDate();labels=Array.from({length:dim},(_,i)=>String(i+1));total=Array(dim).fill(0);accent=Array(dim).fill(0);
inRange.forEach(t=>{const idx=isoToLocal(t.date).getDate()-1;total[idx]+=(t.distance||0);accent[idx]+=(t.accent||0);});
} else if(summaryRange===‚Äò12weeks‚Äô){
for(let w=0;w<12;w++){
const wStart=addDays(start,w*7),wEnd=addDays(wStart,6);
const wNum=getISOWeek(wStart);
labels.push(`Tydz ${wNum}`);weekRanges.push(`${fmtShort(wStart)}‚Äì${fmtShort(wEnd)}`);
const ws=localToISO(wStart),we=localToISO(wEnd);
let ts=0,as=0;inRange.filter(t=>t.date>=ws&&t.date<=we).forEach(t=>{ts+=(t.distance||0);as+=(t.accent||0);});
total.push(ts);accent.push(as);
}
} else {
labels=MONTHS_PL.slice();total=Array(12).fill(0);accent=Array(12).fill(0);
inRange.forEach(t=>{const idx=isoToLocal(t.date).getMonth();total[idx]+=(t.distance||0);accent[idx]+=(t.accent||0);});
}

total=total.map(v=>Math.round(v*100)/100);accent=accent.map(v=>Math.round(v*100)/100);
const totalDist=inRange.reduce((s,t)=>s+(t.distance||0),0);
const totalAccent=inRange.reduce((s,t)=>s+(t.accent||0),0);
const count=inRange.length;
const accentPct=totalDist>0?(totalAccent/totalDist*100):0;
return{labels,total,accent,weekRanges,totalDist,totalAccent,count,accentPct,start,end};
}

function formatPeriodLabel(start,end){
if(summaryRange===‚Äòweek‚Äô)return`${fmtShortY(start)} ‚Äì ${fmtShortY(end)}`;
if(summaryRange===‚Äòmonth‚Äô)return`${MONTHS_FULL_PL[start.getMonth()]} ${start.getFullYear()}`;
if(summaryRange===‚Äò12weeks‚Äô)return`${fmtShortY(start)} ‚Äì ${fmtShortY(end)}`;
return`${start.getFullYear()}`;
}
function canGoBack(){
const trainings=loadTrainings();if(!trainings.length)return false;
const oldest=trainings.map(t=>t.date).sort()[0];
const{start,end}=buildPeriod(summaryOffset-1);
return localToISO(end)>=oldest;
}
function canGoForward(){return summaryOffset<0;}
function setSummaryRange(range){summaryRange=range;summaryOffset=0;document.querySelectorAll(‚Äô.range-btn‚Äô).forEach(b=>b.classList.toggle(‚Äòactive‚Äô,b.dataset.range===range));renderSummary();}
function summaryNav(dir){summaryOffset+=dir;renderSummary();}

// Plugin do asymetrycznego przesuniƒôcia s≈Çupka Akcent w prawo.
// Dzia≈Ça po narysowaniu s≈Çupk√≥w przez Chart.js ‚Äî przesuwa dataset[1] (Akcent)
// tak, by jego lewa krawƒôd≈∫ pokrywa≈Ça siƒô z centrum g≈Ç√≥wnego s≈Çupka (Dystans).
const accentShiftPlugin = {
id: ‚ÄòaccentShift‚Äô,
afterDraw(chart) {
const ctx = chart.ctx;
const datasetAccent = chart.data.datasets[1];
if (!datasetAccent) return;

```
const meta0 = chart.getDatasetMeta(0); // Dystans
const meta1 = chart.getDatasetMeta(1); // Akcent

if (!meta0.data.length || !meta1.data.length) return;

ctx.save();
// Rysuj ponownie s≈Çupki Akcent, przesuniƒôte w prawo
meta1.data.forEach((bar, i) => {
  const mainBar = meta0.data[i];
  if (!mainBar) return;
  const val = chart.data.datasets[1].data[i];
  if (!val || val <= 0) return;

  // Oblicz prawƒÖ krawƒôd≈∫ s≈Çupka g≈Ç√≥wnego
  const mainRight = mainBar.x + mainBar.width / 2;
  const accentW = bar.width;

  // Nowa pozycja: lewa krawƒôd≈∫ Akcentu = prawy ≈õrodek s≈Çupka g≈Ç√≥wnego
  // Tzn. s≈Çupek Akcent zaczyna siƒô od centrum Dystansu i wychodzi w prawo
  const newX = mainRight + accentW * 0.1; // lekkie wciƒôcie dla czytelno≈õci
  const shiftX = newX - (bar.x - bar.width / 2) - accentW / 2;

  // Ukryj oryginalny s≈Çupek Akcent (narysowany przez Chart.js)
  // i narysuj go ponownie w nowej pozycji
  const { base, y, width, height } = bar;
  const x = bar.x + shiftX;

  ctx.fillStyle = 'rgba(255,159,64,0.92)';
  ctx.strokeStyle = 'rgba(220,130,30,1)';
  ctx.lineWidth = 1;

  const radius = 4;
  const left = x - width / 2;
  const top = y;
  const right = x + width / 2;
  const bottom = base;

  if (right - left <= 0 || bottom - top <= 0) return;

  ctx.beginPath();
  ctx.moveTo(left + radius, top);
  ctx.lineTo(right - radius, top);
  ctx.quadraticCurveTo(right, top, right, top + radius);
  ctx.lineTo(right, bottom);
  ctx.lineTo(left, bottom);
  ctx.lineTo(left, top + radius);
  ctx.quadraticCurveTo(left, top, left + radius, top);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();
});
ctx.restore();
```

}
};

// Zarejestruj plugin globalnie
Chart.register(accentShiftPlugin);

function renderSummary(){
const{labels,total,accent,weekRanges,totalDist,totalAccent,count,accentPct,start,end}=aggregateForPeriod();
document.getElementById(‚Äòsum-period-label‚Äô).textContent=formatPeriodLabel(start,end);
document.getElementById(‚Äòsum-prev‚Äô).disabled=!canGoBack();
document.getElementById(‚Äòsum-next‚Äô).disabled=!canGoForward();
document.getElementById(‚Äòstat-total‚Äô).textContent=totalDist.toFixed(2)+‚Äô km‚Äô;
document.getElementById(‚Äòstat-accent‚Äô).textContent=totalAccent.toFixed(2)+‚Äô km‚Äô;
document.getElementById(‚Äòstat-count‚Äô).textContent=count;
document.getElementById(‚Äòstat-accent-pct‚Äô).textContent=accentPct.toFixed(1)+‚Äô %‚Äô;

const ctx=document.getElementById(‚Äòsummary-chart‚Äô).getContext(‚Äò2d‚Äô);
if(summaryChart){summaryChart.destroy();summaryChart=null;}
Chart.defaults.font.family=‚Äù‚ÄòSyne‚Äô, sans-serif‚Äù;

const maxVal=Math.max(‚Ä¶total,0.1);
const magnitude=Math.pow(10,Math.floor(Math.log10(maxVal/5)));
const niceStep=Math.ceil((maxVal/5)/magnitude)*magnitude;
const yMax=Math.ceil(maxVal/niceStep)*niceStep+niceStep;

summaryChart=new Chart(ctx,{
type:‚Äòbar‚Äô,
data:{
labels,
datasets:[
{
label:‚ÄòDystans ca≈Çkowity‚Äô,
data:total,
backgroundColor:‚Äòrgba(164,198,229,0.88)‚Äô,
borderColor:‚Äòrgba(120,165,200,1)‚Äô,
borderWidth:1,
borderRadius:4,
borderSkipped:‚Äòbottom‚Äô,
barPercentage:0.78,
categoryPercentage:0.85,
order:2,
},
{
// S≈Çupek Akcent ‚Äî rysowany przez Chart.js jako ‚Äúplaceholder‚Äù,
// a faktyczne renderowanie z przesuniƒôciem obs≈Çuguje accentShiftPlugin.
// Ustawiamy backgroundColor na transparent, ≈ºeby Chart.js nie rysowa≈Ç
// swojej wersji s≈Çupka (plugin rysuje w≈ÇasnƒÖ kopiƒô).
label:‚ÄòAkcent‚Äô,
data:accent,
backgroundColor:‚Äòrgba(255,159,64,0)‚Äô,    // transparent ‚Äî plugin rysuje
borderColor:‚Äòrgba(0,0,0,0)‚Äô,
borderWidth:0,
borderRadius:4,
borderSkipped:‚Äòbottom‚Äô,
barPercentage:0.40,
categoryPercentage:0.85,
order:1,
}
]
},
options:{
responsive:true,
maintainAspectRatio:false,
grouped:false,
interaction:{mode:‚Äòindex‚Äô,intersect:false},
plugins:{
legend:{display:false},
accentShift:{},   // nasz plugin
tooltip:{
backgroundColor:‚Äô#1f2937‚Äô,titleColor:‚Äô#f9fafb‚Äô,bodyColor:‚Äô#d1d5db‚Äô,
padding:10,cornerRadius:6,
titleFont:{family:‚Äù‚ÄòSyne‚Äô,sans-serif‚Äù,size:12,weight:‚Äòbold‚Äô},
bodyFont:{family:‚Äù‚ÄòDM Mono‚Äô,monospace‚Äù,size:11},
callbacks:{
title(items){
const idx=items[0].dataIndex;
if(summaryRange===‚Äò12weeks‚Äô&&weekRanges[idx])return`${labels[idx]}  (${weekRanges[idx]})`;
return items[0].label;
},
label(item){
const val=item.parsed.y;if(val===0)return null;
return`  ${item.dataset.label}: ${val.toFixed(2)} km`;
}
}
}
},
scales:{
x:{
grid:{display:false},border:{display:false},
ticks:{font:{family:‚Äù‚ÄòDM Mono‚Äô,monospace‚Äù,size:10},color:‚Äô#8a8580‚Äô,maxRotation:summaryRange===‚Äò12weeks‚Äô?35:0,autoSkip:true,maxTicksLimit:summaryRange===‚Äòmonth‚Äô?15:16}
},
y:{
beginAtZero:true,max:yMax,border:{display:false},
grid:{color:‚Äòrgba(0,0,0,0.07)‚Äô,lineWidth:1},
ticks:{font:{family:‚Äù‚ÄòDM Mono‚Äô,monospace‚Äù,size:10},color:‚Äô#8a8580‚Äô,stepSize:niceStep,callback:v=>v>0?v+‚Äô km‚Äô:‚Äò0‚Äô}
}
}
}
});
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
migrateData();
seedData();
buildZoneTable();
loadProfileUI();
renderEndurance();
renderPlanned();
</script>

</body>
</html>

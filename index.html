<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TrainLog</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --ink: #0f0f0f;
      --paper: #f5f2ec;
      --accent: #d4522a;
      --accent-light: #f4e8e3;
      --muted: #8a8580;
      --border: #ddd9d0;
      --card: #ffffff;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Syne', sans-serif; background: var(--paper); color: var(--ink); min-height: 100vh; }
    .mono { font-family: 'DM Mono', monospace; }

    /* â”€â”€ TABS â”€â”€ */
    .tab-btn {
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.78rem;
      letter-spacing: 0.07em; text-transform: uppercase;
      padding: 0.5rem 1rem; border-bottom: 3px solid transparent;
      color: var(--muted); transition: color 0.2s, border-color 0.2s;
      background: none; border-top: none; border-left: none; border-right: none;
      cursor: pointer; white-space: nowrap;
    }
    .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-btn:hover:not(.active) { color: var(--ink); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* â”€â”€ INPUTS â”€â”€ */
    input, textarea, select {
      font-family: 'DM Mono', monospace; font-size: 0.88rem;
      background: var(--paper); border: 1.5px solid var(--border);
      border-radius: 6px; padding: 0.5rem 0.7rem;
      width: 100%; color: var(--ink); transition: border-color 0.2s;
      outline: none; -webkit-appearance: none;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--accent); }
    input[readonly] { background: #edeae3; color: var(--muted); cursor: default; }
    input::placeholder, textarea::placeholder { color: #bbb8b0; }
    label {
      font-size: 0.68rem; font-weight: 700; letter-spacing: 0.07em;
      text-transform: uppercase; color: var(--muted); display: block; margin-bottom: 0.25rem;
    }

    /* â”€â”€ RPE BUTTONS â”€â”€ */
    .rpe-btn {
      font-family: 'DM Mono', monospace; font-size: 0.82rem;
      width: 2.2rem; height: 2.2rem; border-radius: 6px;
      border: 1.5px solid var(--border); background: var(--paper);
      color: var(--muted); cursor: pointer; transition: all 0.15s;
      display: flex; align-items: center; justify-content: center; font-weight: 600;
    }
    .rpe-btn:hover { opacity: 0.85; transform: scale(1.08); }
    .rpe-btn.selected { border-width: 2.5px; color: white !important; }

    /* â”€â”€ BUTTONS â”€â”€ */
    .btn-primary {
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.82rem;
      letter-spacing: 0.06em; text-transform: uppercase;
      background: var(--accent); color: white; border: none;
      border-radius: 8px; padding: 0.65rem 1.75rem; cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }
    .btn-primary:hover { background: #b8401e; }
    .btn-primary:active { transform: scale(0.98); }
    .btn-secondary {
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.82rem;
      letter-spacing: 0.06em; text-transform: uppercase;
      background: transparent; color: var(--muted);
      border: 1.5px solid var(--border); border-radius: 8px;
      padding: 0.65rem 1.25rem; cursor: pointer; transition: all 0.2s;
    }
    .btn-secondary:hover { border-color: var(--muted); color: var(--ink); }
    .btn-ghost {
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.75rem;
      letter-spacing: 0.05em; text-transform: uppercase;
      background: transparent; color: var(--muted);
      border: 1.5px solid var(--border); border-radius: 6px;
      padding: 0.4rem 0.9rem; cursor: pointer; transition: all 0.2s;
    }
    .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
    .btn-ghost.active-panel { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
    .btn-plan {
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.82rem;
      letter-spacing: 0.06em; text-transform: uppercase;
      background: transparent; color: #1d4ed8;
      border: 1.5px solid #93c5fd; border-radius: 8px;
      padding: 0.65rem 1.25rem; cursor: pointer; transition: all 0.2s;
    }
    .btn-plan:hover { background: #eff6ff; border-color: #1d4ed8; }

    /* â”€â”€ FORM CARD â”€â”€ */
    .form-card { background: var(--card); border: 1.5px solid var(--border); border-radius: 12px; padding: 1.25rem; }
    .form-card.editing { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    .edit-banner {
      background: var(--accent-light); border: 1.5px solid #e8c8bc;
      border-radius: 8px; padding: 0.55rem 1rem; margin-bottom: 0.75rem;
      font-size: 0.8rem; color: var(--accent); font-weight: 600;
      display: none; align-items: center; gap: 0.5rem;
    }
    .edit-banner.visible { display: flex; }

    /* â”€â”€ PLANNED TRAININGS TABLE â”€â”€ */
    .planned-section {
      background: #eff6ff; border: 1.5px solid #93c5fd;
      border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.25rem;
    }
    .planned-section-title {
      font-size: 0.68rem; font-weight: 700; letter-spacing: 0.1em;
      text-transform: uppercase; color: #1d4ed8; margin-bottom: 0.75rem;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .planned-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; }
    .planned-table { width: 100%; border-collapse: collapse; font-family: 'DM Mono', monospace; font-size: 0.78rem; }
    .planned-table thead th {
      background: #1d4ed8; color: white;
      padding: 0.45rem 0.65rem; text-align: left;
      font-family: 'Syne', sans-serif; font-size: 0.63rem;
      letter-spacing: 0.07em; text-transform: uppercase; font-weight: 700;
      white-space: nowrap;
    }
    .planned-table tbody tr { border-bottom: 1px solid #bfdbfe; transition: background 0.1s; }
    .planned-table tbody tr:hover { background: #dbeafe; }
    .planned-table tbody td { padding: 0.5rem 0.65rem; vertical-align: middle; color: var(--ink); }
    .execute-btn {
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.68rem;
      letter-spacing: 0.04em; text-transform: uppercase;
      background: #1d4ed8; color: white; border: none;
      border-radius: 5px; padding: 0.3rem 0.7rem; cursor: pointer;
      transition: background 0.15s; white-space: nowrap;
    }
    .execute-btn:hover { background: #1e40af; }
    .delete-plan-btn {
      font-family: 'DM Mono', monospace; font-size: 0.65rem;
      padding: 0.15rem 0.4rem; border-radius: 4px;
      border: 1px solid #bfdbfe; background: none;
      color: #93c5fd; cursor: pointer; transition: all 0.15s; margin-left: 4px;
    }
    .delete-plan-btn:hover { border-color: #c62828; color: #c62828; }

    /* â”€â”€ PLAN MODAL â”€â”€ */
    .modal-overlay {
      display: none; position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.45); align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: var(--card); border-radius: 14px; padding: 1.5rem;
      width: min(480px, 94vw); box-shadow: 0 8px 32px rgba(0,0,0,0.22);
      border: 1.5px solid var(--border);
    }
    .modal-title {
      font-size: 1rem; font-weight: 800; letter-spacing: 0.02em;
      margin-bottom: 1.25rem; color: var(--ink);
      display: flex; align-items: center; justify-content: space-between;
    }
    .modal-close {
      background: none; border: none; cursor: pointer; font-size: 1.3rem;
      color: var(--muted); line-height: 1; padding: 0;
    }
    .modal-close:hover { color: var(--ink); }

    /* â”€â”€ DATA TABLE â”€â”€ */
    .data-table { width: 100%; border-collapse: collapse; font-family: 'DM Mono', monospace; font-size: 0.78rem; }
    .data-table thead th {
      background: var(--ink); color: var(--paper);
      padding: 0.5rem 0.65rem; text-align: left;
      font-family: 'Syne', sans-serif; font-size: 0.65rem;
      letter-spacing: 0.07em; text-transform: uppercase; font-weight: 700;
      white-space: nowrap; user-select: none; position: relative; z-index: 10;
    }
    .data-table thead th.sortable { cursor: pointer; }
    .data-table thead th.sortable:hover { background: #2a2a2a; }
    .data-table thead th .sort-icon { margin-left: 3px; font-size: 0.58rem; opacity: 0.5; }
    .data-table thead th.sort-asc  .sort-icon::after { content: 'â–²'; opacity: 1; }
    .data-table thead th.sort-desc .sort-icon::after { content: 'â–¼'; opacity: 1; }
    .data-table thead th.sortable:not(.sort-asc):not(.sort-desc) .sort-icon::after { content: 'â‡…'; }
    .data-table tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
    .data-table tbody tr:hover { background: #faf8f4; }
    .data-table tbody td { padding: 0.5rem 0.65rem; vertical-align: middle; }

    .task-cell { font-family: 'DM Mono', monospace; font-size: 0.68rem; color: var(--ink); min-width: 180px; max-width: 240px; word-break: break-word; line-height: 1.4; }
    .task-cell.empty { color: var(--border); }

    .compact-table-wrap { border-radius: 10px; border: 1.5px solid var(--border); overflow: hidden; }
    .history-table-scroll { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 10px; border: 1.5px solid var(--border); }
    .history-table-scroll .data-table { min-width: 1080px; }

    /* â”€â”€ TAGS â”€â”€ */
    .tag-sm {
      display: inline-block; font-family: 'DM Mono', monospace;
      font-size: 0.65rem; border-radius: 3px; padding: 0.1rem 0.42rem; white-space: nowrap;
    }
    .tag-activity    { background: #ede9fe; color: #5b21b6; }
    .tag-type-blue   { background: #dbeafe; color: #1e40af; }
    .tag-type-green  { background: #dcfce7; color: #15803d; }
    .tag-type-orange { background: #ffedd5; color: #c2410c; }

    .rpe-dot {
      display: inline-flex; align-items: center; justify-content: center;
      width: 1.6rem; height: 1.6rem; border-radius: 50%;
      font-size: 0.72rem; font-weight: 700; font-family: 'DM Mono', monospace;
    }

    /* â”€â”€ COMMENT TOOLTIP â”€â”€ */
    .comment-cell { position: relative; display: inline-flex; align-items: center; gap: 0.15rem; cursor: pointer; }
    .tooltip-box {
      display: none; position: absolute; z-index: 40;
      top: 50%; left: calc(100% + 8px); transform: translateY(-50%);
      background: #1f2937; color: #f9fafb;
      border-radius: 6px; padding: 0.35rem 0.75rem;
      font-family: 'Syne', sans-serif; font-size: 0.75rem;
      white-space: nowrap; max-width: 280px; overflow: hidden; text-overflow: ellipsis;
      box-shadow: 0 2px 10px rgba(0,0,0,0.22); pointer-events: none; line-height: 1.4;
    }
    .tooltip-box::before {
      content: ''; position: absolute; right: 100%; top: 50%; transform: translateY(-50%);
      border: 5px solid transparent; border-right-color: #1f2937;
    }
    .comment-cell.open .tooltip-box { display: block; }

    .row-btn {
      font-family: 'DM Mono', monospace; font-size: 0.65rem;
      padding: 0.15rem 0.45rem; border-radius: 4px;
      border: 1px solid var(--border); background: none;
      color: var(--muted); cursor: pointer; transition: all 0.15s; margin-left: 2px;
    }
    .row-btn:hover     { border-color: var(--accent); color: var(--accent); }
    .row-btn.del:hover { border-color: #c62828; color: #c62828; }

    /* â”€â”€ ZONE TIME (form) â”€â”€ */
    .zone-time-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 0.5rem; margin-top: 0.6rem; }
    .zone-time-item label { font-size: 0.62rem; }
    .zone-time-cell { font-family: 'DM Mono', monospace; font-size: 0.68rem; color: var(--muted); white-space: nowrap; }
    .zone-time-cell span { display: inline-block; margin-right: 0.25rem; }
    .zone-col-th { transition: width 0.2s; }
    .zone-toggle-btn {
      background: none; border: none; cursor: pointer; font-size: 0.75rem;
      color: var(--paper); opacity: 0.7; padding: 0 0.2rem; vertical-align: middle;
    }
    .zone-toggle-btn:hover { opacity: 1; }

    /* â”€â”€ EXCL TOGGLE â”€â”€ */
    .excl-toggle {
      font-family: 'DM Mono', monospace; font-size: 0.8rem;
      padding: 0.2rem 0.55rem; border-radius: 5px;
      border: 1.5px solid var(--border); background: var(--paper);
      cursor: pointer; color: var(--muted); transition: all 0.15s;
      display: inline-flex; align-items: center; gap: 0.3rem;
    }
    .excl-toggle.on { background: #fef3c7; border-color: #f59e0b; color: #92400e; }

    /* â•â• MULTI-SELECT DROPDOWN FILTER â•â• */
    .ms-filter { position: relative; display: inline-block; }
    .ms-trigger {
      font-family: 'DM Mono', monospace; font-size: 0.78rem;
      padding: 0.32rem 0.6rem; border: 1.5px solid var(--border);
      border-radius: 6px; background: var(--paper); color: var(--ink);
      cursor: pointer; display: flex; align-items: center; gap: 0.4rem;
      white-space: nowrap; transition: border-color 0.15s; user-select: none;
      min-width: 110px;
    }
    .ms-trigger:hover, .ms-trigger.open { border-color: var(--accent); }
    .ms-trigger .ms-arrow { margin-left: auto; font-size: 0.55rem; color: var(--muted); transition: transform 0.15s; }
    .ms-trigger.open .ms-arrow { transform: rotate(180deg); }
    .ms-badge {
      background: var(--accent); color: white; border-radius: 10px;
      font-size: 0.6rem; font-weight: 700; padding: 0.05rem 0.35rem;
      font-family: 'Syne', sans-serif; min-width: 1.1rem; text-align: center;
    }
    .ms-dropdown {
      display: none; position: absolute; top: calc(100% + 4px); left: 0; z-index: 100;
      background: var(--card); border: 1.5px solid var(--border);
      border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      min-width: 180px; max-height: 260px; overflow-y: auto; padding: 0.35rem 0;
    }
    .ms-dropdown.open { display: block; }
    .ms-option {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.4rem 0.75rem; cursor: pointer;
      font-family: 'DM Mono', monospace; font-size: 0.78rem; color: var(--ink);
      transition: background 0.1s;
    }
    .ms-option:hover { background: var(--paper); }
    .ms-option input[type="checkbox"] {
      width: 0.9rem; height: 0.9rem; accent-color: var(--accent);
      cursor: pointer; flex-shrink: 0; border: none; padding: 0;
      -webkit-appearance: auto; appearance: auto;
    }
    .ms-divider { height: 1px; background: var(--border); margin: 0.25rem 0; }
    .ms-clear {
      font-family: 'Syne', sans-serif; font-size: 0.65rem; font-weight: 700;
      color: var(--accent); padding: 0.3rem 0.75rem; cursor: pointer;
      letter-spacing: 0.05em; text-transform: uppercase;
    }
    .ms-clear:hover { text-decoration: underline; }

    /* â”€â”€ FILTER BAR â”€â”€ */
    .filter-bar { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; margin-bottom: 1rem; }
    .filter-group { display: flex; align-items: center; gap: 0.3rem; }
    .filter-group label { display: inline; font-size: 0.65rem; margin: 0; white-space: nowrap; }
    .filter-group select { width: auto; font-size: 0.78rem; padding: 0.3rem 0.55rem; }

    /* â”€â”€ PROFILE â”€â”€ */
    .profile-card { background: var(--card); border: 1.5px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.25rem; }
    .section-title { font-size: 0.68rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.75rem; }
    .zone-table { width: 100%; border-collapse: collapse; font-family: 'DM Mono', monospace; font-size: 0.82rem; }
    .zone-table th {
      background: var(--ink); color: var(--paper); padding: 0.45rem 0.6rem; text-align: center;
      font-family: 'Syne', sans-serif; font-size: 0.63rem; letter-spacing: 0.06em; text-transform: uppercase; font-weight: 700;
    }
    .zone-table td { padding: 0.4rem 0.5rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
    .zone-table td:first-child { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.78rem; white-space: nowrap; }
    .zone-table input { font-size: 0.82rem; padding: 0.3rem 0.4rem; text-align: center; }
    .zone-1{color:#38bdf8;} .zone-2{color:#1d4ed8;} .zone-3{color:#16a34a;} .zone-4{color:#ea580c;} .zone-5{color:#dc2626;}
    .validation-error { font-family: 'DM Mono', monospace; font-size: 0.72rem; color: #c62828; margin-top: 0.5rem; display: none; }

    /* â”€â”€ MISC â”€â”€ */
    .show-all-link { font-family: 'Syne', sans-serif; font-size: 0.78rem; font-weight: 700; color: var(--accent); cursor: pointer; border: none; background: none; padding: 0; }
    .show-all-link:hover { text-decoration: underline; }
    .empty-state { text-align: center; padding: 2.5rem 1rem; color: var(--muted); }
    .empty-state .big { font-size: 2.5rem; margin-bottom: 0.4rem; }
    @keyframes fadeSlideIn { from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);} }
    .animate-in { animation: fadeSlideIn 0.25s ease forwards; }
    ::-webkit-scrollbar { width:5px;height:5px; }
    ::-webkit-scrollbar-track { background:transparent; }
    ::-webkit-scrollbar-thumb { background:var(--border);border-radius:3px; }
  </style>
</head>
<body>

<!-- â•â• PLAN MODAL â•â• -->
<div class="modal-overlay" id="plan-modal" onclick="if(event.target===this)closePlanModal()">
  <div class="modal-box">
    <div class="modal-title">
      <span>ğŸ“… Zaplanuj trening</span>
      <button class="modal-close" onclick="closePlanModal()">Ã—</button>
    </div>
    <div class="mb-3">
      <label>Data (opcjonalnie)</label>
      <input type="date" id="pm-date" />
    </div>
    <div class="mb-3">
      <label>Rodzaj treningu</label>
      <select id="pm-type">
        <option value="baza tlenowa">Baza tlenowa</option>
        <option value="zabawa biegowa">Zabawa biegowa</option>
        <option value="okoÅ‚o progowy">OkoÅ‚o progowy</option>
        <option value="ciÄ…gÅ‚y">CiÄ…gÅ‚y</option>
        <option value="interwaÅ‚owy">InterwaÅ‚owy</option>
        <option value="inny">Inny</option>
      </select>
    </div>
    <div class="mb-4">
      <label>Zadanie / Uwagi</label>
      <textarea id="pm-task" rows="3" placeholder="np. 4Ã—500m p. 2 min, uwagi do treningu..." style="resize:none;"></textarea>
    </div>
    <div class="flex gap-3">
      <button class="btn-primary" onclick="savePlan()">Zapisz plan</button>
      <button class="btn-secondary" onclick="closePlanModal()">Anuluj</button>
    </div>
  </div>
</div>

<!-- HEADER -->
<header class="sticky top-0 z-50" style="background:var(--paper);border-bottom:1.5px solid var(--border);">
  <div class="max-w-5xl mx-auto px-4">
    <div class="flex items-baseline gap-3 pt-3 pb-1">
      <h1 class="text-xl font-extrabold tracking-tight">Train<span style="color:var(--accent)">Log</span></h1>
      <span class="mono text-xs" style="color:var(--muted);">v0.7</span>
    </div>
    <nav class="flex mt-1" style="overflow-x:auto;-webkit-overflow-scrolling:touch;gap:0;">
      <button class="tab-btn" data-tab="profile">Profil</button>
      <button class="tab-btn active" data-tab="endurance">WytrzymaÅ‚oÅ›Ä‡</button>
      <button class="tab-btn" data-tab="fitness">SprawnoÅ›Ä‡</button>
      <button class="tab-btn" data-tab="summary">Podsumowanie</button>
    </nav>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-5">

  <!-- â•â• TAB: WYTRZYMAÅOÅšÄ† â•â• -->
  <div id="tab-endurance" class="tab-content active animate-in">

    <!-- Top row: title + plan button -->
    <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
      <h2 class="text-lg font-bold">WytrzymaÅ‚oÅ›Ä‡</h2>
      <button class="btn-plan" onclick="openPlanModal()">+ Zaplanuj trening</button>
    </div>

    <!-- PLANNED SECTION -->
    <div class="planned-section" id="planned-section" style="display:none;">
      <div class="planned-section-title">
        ğŸ“‹ Zaplanowane
        <span class="mono" style="font-size:0.65rem;color:#3b82f6;font-weight:400;" id="planned-count"></span>
      </div>
      <div class="planned-scroll">
        <table class="planned-table" id="planned-table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Typ</th>
              <th>Zadanie / Uwagi</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="planned-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- EDIT BANNER -->
    <div class="edit-banner" id="edit-banner">
      âœï¸ Tryb edycji â€” wprowadÅº zmiany i kliknij "Zapisz zmiany"
      <button onclick="cancelEdit()" style="margin-left:auto;font-size:0.73rem;text-decoration:underline;background:none;border:none;color:var(--accent);cursor:pointer;font-family:'Syne',sans-serif;font-weight:700;">Anuluj</button>
    </div>

    <!-- MAIN FORM -->
    <div class="form-card mb-5" id="form-card">
      <!-- plan source indicator -->
      <div id="plan-source-banner" style="display:none;background:#eff6ff;border:1.5px solid #93c5fd;border-radius:6px;padding:0.4rem 0.75rem;margin-bottom:0.75rem;font-size:0.78rem;color:#1d4ed8;font-family:'Syne',sans-serif;font-weight:600;">
        ğŸ“‹ Realizujesz zaplanowany trening â€” wypeÅ‚nij pozostaÅ‚e dane i kliknij "+ Dodaj trening"
        <button onclick="clearPlanSource()" style="margin-left:0.5rem;font-size:0.72rem;text-decoration:underline;background:none;border:none;color:#1d4ed8;cursor:pointer;font-family:'Syne',sans-serif;font-weight:700;">OdÅ‚Ä…cz</button>
      </div>

      <div class="mb-3">
        <label>Data treningu</label>
        <input type="date" id="f-date" style="width:auto;min-width:165px;" />
      </div>
      <div class="grid grid-cols-2 gap-3 mb-3">
        <div>
          <label>Rodzaj aktywnoÅ›ci</label>
          <select id="f-activity">
            <option value="bieg">Bieg</option>
            <option value="bieÅ¼nia lekkoatletyczna">BieÅ¼nia lekkoatletyczna</option>
            <option value="bieÅ¼nia mechaniczna">BieÅ¼nia mechaniczna</option>
            <option value="inny">Inny</option>
          </select>
        </div>
        <div>
          <label>Rodzaj treningu</label>
          <select id="f-type">
            <option value="baza tlenowa">Baza tlenowa</option>
            <option value="zabawa biegowa">Zabawa biegowa</option>
            <option value="okoÅ‚o progowy">OkoÅ‚o progowy</option>
            <option value="ciÄ…gÅ‚y">CiÄ…gÅ‚y</option>
            <option value="interwaÅ‚owy">InterwaÅ‚owy</option>
            <option value="inny">Inny</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3 mb-3">
        <div><label>Dystans (km)</label><input type="number" id="f-distance" placeholder="0.00" step="0.01" min="0" /></div>
        <div><label>Akcent (km)</label><input type="number" id="f-accent" placeholder="0.00" step="0.01" min="0" /></div>
      </div>
      <div class="grid grid-cols-2 gap-3 mb-4">
        <div><label>Czas</label><input type="text" id="f-duration" placeholder="00:00" inputmode="numeric" /></div>
        <div><label>Åšrednie tempo (min/km)</label><input type="text" id="f-pace" readonly placeholder="â€”" /></div>
      </div>

      <!-- ZADANIE -->
      <div class="mb-3">
        <button class="btn-ghost" id="task-toggle-btn" onclick="toggleTask()">Zadanie</button>
        <div id="task-field" style="display:none;margin-top:0.6rem;">
          <label>Opis zadania</label>
          <input type="text" id="f-task" placeholder="np. 4Ã—500m p. 2 min" />
        </div>
      </div>

      <!-- RPE + zones -->
      <div class="mb-3">
        <div class="flex items-center gap-3 mb-2 flex-wrap">
          <label style="margin:0;">Ocena wysiÅ‚ku (RPE)</label>
          <button class="btn-ghost" id="zone-time-toggle-btn" onclick="toggleZoneTime()">Czas w strefach</button>
        </div>
        <div class="flex flex-wrap gap-2" id="rpe-buttons"></div>
      </div>
      <div id="zone-time-fields" style="display:none;" class="mb-4">
        <div class="zone-time-grid">
          <div class="zone-time-item"><label style="color:#38bdf8;">Strefa 1</label><input type="text" id="zt-1" placeholder="00:00" inputmode="numeric" /></div>
          <div class="zone-time-item"><label style="color:#1d4ed8;">Strefa 2</label><input type="text" id="zt-2" placeholder="00:00" inputmode="numeric" /></div>
          <div class="zone-time-item"><label style="color:#16a34a;">Strefa 3</label><input type="text" id="zt-3" placeholder="00:00" inputmode="numeric" /></div>
          <div class="zone-time-item"><label style="color:#ea580c;">Strefa 4</label><input type="text" id="zt-4" placeholder="00:00" inputmode="numeric" /></div>
          <div class="zone-time-item"><label style="color:#dc2626;">Strefa 5</label><input type="text" id="zt-5" placeholder="00:00" inputmode="numeric" /></div>
        </div>
      </div>

      <!-- NOTE -->
      <div class="mb-4">
        <label>Komentarz</label>
        <textarea id="f-note" rows="2" placeholder="KrÃ³tki komentarz..." style="resize:none;"></textarea>
        <div style="display:flex;align-items:center;gap:0.6rem;margin-top:0.5rem;">
          <button class="excl-toggle" id="excl-btn" onclick="toggleExcl()">â— WaÅ¼ne</button>
          <span class="mono" style="font-size:0.68rem;color:var(--muted);">Oznacz komentarz jako waÅ¼ny</span>
        </div>
      </div>

      <div class="flex items-center gap-3 flex-wrap">
        <button class="btn-primary" id="add-btn">+ Dodaj trening</button>
        <button class="btn-secondary" id="cancel-btn" onclick="cancelEdit()" style="display:none;">Anuluj</button>
        <span class="mono text-xs" id="form-error" style="color:var(--accent);display:none;"></span>
      </div>
    </div>

    <!-- LAST 5 -->
    <div class="flex items-center justify-between mb-2">
      <span class="section-title" style="margin:0;">Ostatnie treningi</span>
    </div>
    <div class="compact-table-wrap mb-3">
      <div id="endurance-table-body"></div>
    </div>
    <div style="text-align:right;">
      <button class="show-all-link" onclick="openHistory()">Zobacz wszystkie â†’</button>
    </div>
  </div>

  <!-- â•â• TAB: HISTORIA â•â• -->
  <div id="tab-history" class="tab-content">
    <div class="flex items-center gap-3 mb-4 flex-wrap">
      <h2 class="text-lg font-bold">Historia</h2>
      <button class="btn-ghost" onclick="switchTab('endurance')" style="font-size:0.7rem;">â† WrÃ³Ä‡</button>
    </div>

    <!-- FILTERS -->
    <div class="filter-bar" id="history-filter-bar">
      <!-- Rok (single select) -->
      <div class="filter-group">
        <label>Rok</label>
        <select id="h-filter-year" onchange="renderHistory()" style="width:auto;font-size:0.78rem;padding:0.3rem 0.55rem;">
          <option value="">Wszystkie</option>
        </select>
      </div>

      <!-- MiesiÄ…c (multi) -->
      <div class="filter-group">
        <label>MiesiÄ…c</label>
        <div class="ms-filter" id="ms-month">
          <div class="ms-trigger" onclick="toggleMsDropdown('ms-month')">
            <span class="ms-label">Wszystkie</span>
            <span class="ms-badge" style="display:none;"></span>
            <span class="ms-arrow">â–¼</span>
          </div>
          <div class="ms-dropdown">
            <div class="ms-clear" onclick="clearMs('ms-month')">WyczyÅ›Ä‡</div>
            <div class="ms-divider"></div>
            <label class="ms-option"><input type="checkbox" value="01" onchange="msChanged('ms-month')"> StyczeÅ„</label>
            <label class="ms-option"><input type="checkbox" value="02" onchange="msChanged('ms-month')"> Luty</label>
            <label class="ms-option"><input type="checkbox" value="03" onchange="msChanged('ms-month')"> Marzec</label>
            <label class="ms-option"><input type="checkbox" value="04" onchange="msChanged('ms-month')"> KwiecieÅ„</label>
            <label class="ms-option"><input type="checkbox" value="05" onchange="msChanged('ms-month')"> Maj</label>
            <label class="ms-option"><input type="checkbox" value="06" onchange="msChanged('ms-month')"> Czerwiec</label>
            <label class="ms-option"><input type="checkbox" value="07" onchange="msChanged('ms-month')"> Lipiec</label>
            <label class="ms-option"><input type="checkbox" value="08" onchange="msChanged('ms-month')"> SierpieÅ„</label>
            <label class="ms-option"><input type="checkbox" value="09" onchange="msChanged('ms-month')"> WrzesieÅ„</label>
            <label class="ms-option"><input type="checkbox" value="10" onchange="msChanged('ms-month')"> PaÅºdziernik</label>
            <label class="ms-option"><input type="checkbox" value="11" onchange="msChanged('ms-month')"> Listopad</label>
            <label class="ms-option"><input type="checkbox" value="12" onchange="msChanged('ms-month')"> GrudzieÅ„</label>
          </div>
        </div>
      </div>

      <!-- AktywnoÅ›Ä‡ (multi) -->
      <div class="filter-group">
        <label>Akt.</label>
        <div class="ms-filter" id="ms-activity">
          <div class="ms-trigger" onclick="toggleMsDropdown('ms-activity')">
            <span class="ms-label">Wszystkie</span>
            <span class="ms-badge" style="display:none;"></span>
            <span class="ms-arrow">â–¼</span>
          </div>
          <div class="ms-dropdown">
            <div class="ms-clear" onclick="clearMs('ms-activity')">WyczyÅ›Ä‡</div>
            <div class="ms-divider"></div>
            <label class="ms-option"><input type="checkbox" value="bieg" onchange="msChanged('ms-activity')"> Bieg</label>
            <label class="ms-option"><input type="checkbox" value="bieÅ¼nia lekkoatletyczna" onchange="msChanged('ms-activity')"> BieÅ¼nia lekkoatletyczna</label>
            <label class="ms-option"><input type="checkbox" value="bieÅ¼nia mechaniczna" onchange="msChanged('ms-activity')"> BieÅ¼nia mechaniczna</label>
            <label class="ms-option"><input type="checkbox" value="inny" onchange="msChanged('ms-activity')"> Inny</label>
          </div>
        </div>
      </div>

      <!-- Typ (multi) -->
      <div class="filter-group">
        <label>Typ</label>
        <div class="ms-filter" id="ms-type">
          <div class="ms-trigger" onclick="toggleMsDropdown('ms-type')">
            <span class="ms-label">Wszystkie</span>
            <span class="ms-badge" style="display:none;"></span>
            <span class="ms-arrow">â–¼</span>
          </div>
          <div class="ms-dropdown">
            <div class="ms-clear" onclick="clearMs('ms-type')">WyczyÅ›Ä‡</div>
            <div class="ms-divider"></div>
            <label class="ms-option"><input type="checkbox" value="baza tlenowa" onchange="msChanged('ms-type')"> Baza tlenowa</label>
            <label class="ms-option"><input type="checkbox" value="zabawa biegowa" onchange="msChanged('ms-type')"> Zabawa biegowa</label>
            <label class="ms-option"><input type="checkbox" value="okoÅ‚o progowy" onchange="msChanged('ms-type')"> OkoÅ‚o progowy</label>
            <label class="ms-option"><input type="checkbox" value="ciÄ…gÅ‚y" onchange="msChanged('ms-type')"> CiÄ…gÅ‚y</label>
            <label class="ms-option"><input type="checkbox" value="interwaÅ‚owy" onchange="msChanged('ms-type')"> InterwaÅ‚owy</label>
            <label class="ms-option"><input type="checkbox" value="inny" onchange="msChanged('ms-type')"> Inny</label>
          </div>
        </div>
      </div>

      <!-- RPE (single) -->
      <div class="filter-group">
        <label>RPE</label>
        <select id="h-filter-rpe" onchange="renderHistory()" style="width:auto;font-size:0.78rem;padding:0.3rem 0.55rem;">
          <option value="">Wszystkie</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option><option value="9">9</option>
          <option value="10">10</option>
        </select>
      </div>

      <button class="btn-secondary" style="padding:0.32rem 0.7rem;font-size:0.72rem;" onclick="clearAllFilters()">WyczyÅ›Ä‡ wszystko</button>
    </div>

    <div class="history-table-scroll">
      <div id="history-table-body"></div>
    </div>
  </div>

  <!-- â•â• TAB: SPRAWNOÅšÄ† â•â• -->
  <div id="tab-fitness" class="tab-content">
    <h2 class="text-lg font-bold mb-3">SprawnoÅ›Ä‡</h2>
    <div class="empty-state"><div class="big">ğŸ‹ï¸</div><p class="font-semibold" style="color:var(--muted);">WkrÃ³tce tutaj</p></div>
  </div>

  <!-- â•â• TAB: PODSUMOWANIE â•â• -->
  <div id="tab-summary" class="tab-content">
    <h2 class="text-lg font-bold mb-3">Podsumowanie</h2>
    <div class="empty-state"><div class="big">ğŸ“Š</div><p class="font-semibold" style="color:var(--muted);">Statystyki â€” wkrÃ³tce</p></div>
  </div>

  <!-- â•â• TAB: PROFIL â•â• -->
  <div id="tab-profile" class="tab-content">
    <h2 class="text-lg font-bold mb-4">Profil</h2>
    <div class="profile-card">
      <div class="section-title">Dane fizyczne</div>
      <div class="grid grid-cols-2 gap-3">
        <div><label>Wzrost (cm)</label><input type="number" id="p-height" placeholder="175" min="100" max="250" /></div>
        <div><label>Waga (kg)</label><input type="number" id="p-weight" placeholder="70.0" step="0.1" min="30" max="300" /></div>
      </div>
    </div>
    <div class="profile-card">
      <div class="section-title">Strefy treningowe</div>
      <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;border-radius:8px;border:1.5px solid var(--border);">
        <table class="zone-table">
          <thead>
            <tr>
              <th rowspan="2" style="text-align:left;padding-left:0.75rem;">Strefa</th>
              <th colspan="2">TÄ™tno (BPM)</th>
              <th colspan="2">Tempo (min/km)</th>
              <th colspan="2">Moc (W)</th>
            </tr>
            <tr style="background:#222;">
              <th>Min</th><th>Max</th><th>Min</th><th>Max</th><th>Min</th><th>Max</th>
            </tr>
          </thead>
          <tbody id="zone-tbody"></tbody>
        </table>
      </div>
      <div class="validation-error" id="zone-error">âš ï¸ Minimum strefy wyÅ¼szej musi byÄ‡ wiÄ™ksze niÅ¼ maksimum strefy niÅ¼szej.</div>
      <div style="margin-top:1rem;display:flex;align-items:center;gap:1rem;">
        <button class="btn-primary" onclick="saveProfile()">Zapisz profil</button>
        <span class="mono text-xs" id="profile-saved" style="color:#2e7d32;display:none;">âœ“ Zapisano</span>
      </div>
    </div>
  </div>

</main>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE KEYS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE_KEY  = 'trainlog_endurance_v1';
const PROFILE_KEY  = 'trainlog_profile_v1';
const PLANNED_KEY  = 'trainlog_planned_v1';

const ZONE_DISPLAY = [
  {num:5,label:'> Strefa 5',cls:'zone-5'},
  {num:4,label:'Strefa 4',  cls:'zone-4'},
  {num:3,label:'Strefa 3',  cls:'zone-3'},
  {num:2,label:'Strefa 2',  cls:'zone-2'},
  {num:1,label:'Strefa 1',  cls:'zone-1'},
];

const RPE_PALETTE = {
  1:{bg:'#e0f2fe',border:'#38bdf8',text:'#0369a1'},
  2:{bg:'#bae6fd',border:'#0ea5e9',text:'#0369a1'},
  3:{bg:'#bbf7d0',border:'#4ade80',text:'#15803d'},
  4:{bg:'#86efac',border:'#22c55e',text:'#15803d'},
  5:{bg:'#fef08a',border:'#facc15',text:'#854d0e'},
  6:{bg:'#fde047',border:'#eab308',text:'#713f12'},
  7:{bg:'#fed7aa',border:'#fb923c',text:'#9a3412'},
  8:{bg:'#fdba74',border:'#f97316',text:'#7c2d12'},
  9:{bg:'#fca5a5',border:'#ef4444',text:'#991b1b'},
  10:{bg:'#581c87',border:'#7c3aed',text:'#ede9fe'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD / SAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadTrainings()  { try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||[];}catch{return[];} }
function saveTrainings(d) { localStorage.setItem(STORAGE_KEY,JSON.stringify(d)); }
function loadProfile()    { try{return JSON.parse(localStorage.getItem(PROFILE_KEY))||{};}catch{return{};} }
function saveProfileData(d){localStorage.setItem(PROFILE_KEY,JSON.stringify(d));}
function loadPlanned()    { try{return JSON.parse(localStorage.getItem(PLANNED_KEY))||[];}catch{return[];} }
function savePlanned(d)   { localStorage.setItem(PLANNED_KEY,JSON.stringify(d)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEED DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function seedData(){
  if(loadTrainings().length>0) return;
  saveTrainings([
    {id:1738800000001,date:'2025-02-06',activity:'bieg',type:'baza tlenowa', rpe:6,distance:6.06,durationSeconds:2129,accent:0,note:'',commentExcl:false,zoneTimes:{},task:''},
    {id:1738800000002,date:'2025-02-07',activity:'bieg',type:'okoÅ‚o progowy',rpe:8,distance:8.05,durationSeconds:2717,accent:0,note:'',commentExcl:false,zoneTimes:{},task:''},
  ]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MIGRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function migrateData(){
  const t=loadTrainings(); let c=false;
  t.forEach(x=>{
    if(x.durationSeconds==null&&x.duration!=null){x.durationSeconds=Math.round(x.duration*60);c=true;}
    if(x.commentExcl==null){x.commentExcl=false;c=true;}
    if(!x.zoneTimes){x.zoneTimes={};c=true;}
    if(x.task==null){x.task='';c=true;}
    if(x.type==='bieg ciÄ…gÅ‚y'){x.type='ciÄ…gÅ‚y';c=true;}
    if(x.type==='bieg interwaÅ‚owy'){x.type='interwaÅ‚owy';c=true;}
    if('commentColor'in x){delete x.commentColor;c=true;}
  });
  if(c) saveTrainings(t);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function todayISO(){
  const n=new Date();
  return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
}
function formatDatePL(iso){
  if(!iso) return 'â€”';
  const [y,m,d]=iso.split('-');
  return `${d}.${m}.${y}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab===name));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  const el=document.getElementById('tab-'+name);
  el.classList.add('active');
  el.classList.remove('animate-in'); void el.offsetWidth; el.classList.add('animate-in');
  if(name==='endurance'){renderEndurance();renderPlanned();}
}
function openHistory(){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  const el=document.getElementById('tab-history');
  el.classList.add('active');
  el.classList.remove('animate-in'); void el.offsetWidth; el.classList.add('animate-in');
  populateYearFilter();
  renderHistory();
}
document.querySelectorAll('.tab-btn').forEach(btn=>btn.addEventListener('click',()=>switchTab(btn.dataset.tab)));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MULTI-SELECT DROPDOWNS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleMsDropdown(id){
  const wrap=document.getElementById(id);
  const trigger=wrap.querySelector('.ms-trigger');
  const dropdown=wrap.querySelector('.ms-dropdown');
  const isOpen=dropdown.classList.contains('open');
  // close all others first
  document.querySelectorAll('.ms-dropdown.open').forEach(d=>{
    d.classList.remove('open');
    d.closest('.ms-filter').querySelector('.ms-trigger').classList.remove('open');
  });
  if(!isOpen){
    dropdown.classList.add('open');
    trigger.classList.add('open');
  }
}
// close dropdowns on outside click
document.addEventListener('click',e=>{
  if(!e.target.closest('.ms-filter')){
    document.querySelectorAll('.ms-dropdown.open').forEach(d=>{
      d.classList.remove('open');
      d.closest('.ms-filter').querySelector('.ms-trigger').classList.remove('open');
    });
  }
  if(!e.target.closest('.comment-cell'))
    document.querySelectorAll('.comment-cell.open').forEach(c=>c.classList.remove('open'));
});

function msChanged(id){
  const wrap=document.getElementById(id);
  const checked=[...wrap.querySelectorAll('input[type="checkbox"]:checked')];
  const badge=wrap.querySelector('.ms-badge');
  const labelEl=wrap.querySelector('.ms-label');
  if(checked.length===0){
    badge.style.display='none';
    labelEl.textContent='Wszystkie';
  } else {
    badge.textContent=checked.length;
    badge.style.display='inline-block';
    labelEl.textContent=checked.length===1?checked[0].parentElement.textContent.trim():`${checked.length} wybrane`;
  }
  renderHistory();
}
function clearMs(id){
  const wrap=document.getElementById(id);
  wrap.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
  msChanged(id);
}
function getMsValues(id){
  return [...document.getElementById(id).querySelectorAll('input[type="checkbox"]:checked')].map(cb=>cb.value);
}
function clearAllFilters(){
  document.getElementById('h-filter-year').value='';
  document.getElementById('h-filter-rpe').value='';
  ['ms-month','ms-activity','ms-type'].forEach(id=>clearMs(id));
  renderHistory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAN MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPlanModal(){
  document.getElementById('pm-date').value='';
  document.getElementById('pm-type').value='baza tlenowa';
  document.getElementById('pm-task').value='';
  document.getElementById('plan-modal').classList.add('open');
}
function closePlanModal(){
  document.getElementById('plan-modal').classList.remove('open');
}
function savePlan(){
  const date=document.getElementById('pm-date').value;
  const type=document.getElementById('pm-type').value;
  const task=document.getElementById('pm-task').value.trim();
  const plans=loadPlanned();
  plans.push({id:Date.now(),date,type,task});
  savePlanned(plans);
  closePlanModal();
  renderPlanned();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLANNED TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pendingPlanId=null; // ID of plan being executed

function renderPlanned(){
  const plans=loadPlanned();
  const section=document.getElementById('planned-section');
  if(plans.length===0){section.style.display='none';return;}
  section.style.display='block';
  document.getElementById('planned-count').textContent=`(${plans.length})`;
  const tbody=document.getElementById('planned-tbody');
  tbody.innerHTML=plans.map(p=>`
    <tr>
      <td class="mono" style="white-space:nowrap;">${p.date?formatDatePL(p.date):'â€”'}</td>
      <td><span class="tag-sm ${typeTagClass(p.type)}">${escHtml(p.type||'â€”')}</span></td>
      <td style="font-family:'DM Mono',monospace;font-size:0.75rem;max-width:200px;word-break:break-word;">${escHtml(p.task||'â€”')}</td>
      <td style="white-space:nowrap;">
        <button class="execute-btn" onclick="executePlan(${p.id})">â–¶ Wykonaj</button>
        <button class="delete-plan-btn" onclick="deletePlan(${p.id})" title="UsuÅ„ plan">Ã—</button>
      </td>
    </tr>`).join('');
}

window.executePlan=function(id){
  const plans=loadPlanned();
  const p=plans.find(x=>x.id===id);
  if(!p) return;
  pendingPlanId=id;
  // fill form
  document.getElementById('f-type').value=p.type||'baza tlenowa';
  if(p.date) document.getElementById('f-date').value=p.date;
  // show task field
  document.getElementById('f-task').value=p.task||'';
  if(p.task&&!taskVisible) toggleTask();
  // show banner
  document.getElementById('plan-source-banner').style.display='block';
  document.getElementById('form-card').scrollIntoView({behavior:'smooth',block:'start'});
};

window.deletePlan=function(id){
  if(!confirm('UsunÄ…Ä‡ ten plan?')) return;
  if(pendingPlanId===id) clearPlanSource();
  savePlanned(loadPlanned().filter(x=>x.id!==id));
  renderPlanned();
};

function clearPlanSource(){
  pendingPlanId=null;
  document.getElementById('plan-source-banner').style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RPE BUTTONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedRPE=null;
function rpeButtonStyle(n,selected){
  const p=RPE_PALETTE[n];
  if(selected) return `background:${p.bg};border-color:${p.border};color:${p.text};border-width:2.5px;`;
  return `background:var(--paper);border-color:var(--border);color:var(--muted);`;
}
(function buildRPE(){
  const c=document.getElementById('rpe-buttons');
  for(let i=1;i<=10;i++){
    const b=document.createElement('button');
    b.className='rpe-btn'; b.textContent=i; b.dataset.rpe=i;
    b.style.cssText=rpeButtonStyle(i,false);
    b.addEventListener('mouseenter',()=>{
      if(selectedRPE!==i){const p=RPE_PALETTE[i];b.style.cssText=`background:${p.bg};border-color:${p.border};color:${p.text};border-width:1.5px;transform:scale(1.08);`;}
    });
    b.addEventListener('mouseleave',()=>{b.style.cssText=rpeButtonStyle(i,selectedRPE===i);});
    b.addEventListener('click',()=>{selectedRPE=selectedRPE===i?null:i;refreshRPE();});
    c.appendChild(b);
  }
})();
function refreshRPE(){
  document.querySelectorAll('.rpe-btn').forEach(b=>{
    const n=parseInt(b.dataset.rpe);
    b.style.cssText=rpeButtonStyle(n,n===selectedRPE);
    b.classList.toggle('selected',n===selectedRPE);
  });
}
function rpeDotStyle(rpe){
  if(!rpe) return{bg:'#e5e7eb',color:'#6b7280',border:'#e5e7eb'};
  const p=RPE_PALETTE[rpe]; return{bg:p.bg,color:p.text,border:p.border};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOGGLE PANELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let taskVisible=false;
function toggleTask(){
  taskVisible=!taskVisible;
  document.getElementById('task-field').style.display=taskVisible?'block':'none';
  document.getElementById('task-toggle-btn').classList.toggle('active-panel',taskVisible);
}
let zoneTimeVisible=false;
function toggleZoneTime(){
  zoneTimeVisible=!zoneTimeVisible;
  document.getElementById('zone-time-fields').style.display=zoneTimeVisible?'block':'none';
  document.getElementById('zone-time-toggle-btn').classList.toggle('active-panel',zoneTimeVisible);
}
let zoneColExpanded=false;
function toggleZoneCol(){
  zoneColExpanded=!zoneColExpanded;
  const btn=document.getElementById('zone-col-btn');
  if(btn) btn.textContent=zoneColExpanded?'âˆ’':'+';
  document.querySelectorAll('.zone-col-th').forEach(th=>th.style.width=zoneColExpanded?'auto':'2.2rem');
  document.querySelectorAll('.zone-col-td').forEach(td=>{
    td.style.maxWidth=zoneColExpanded?'300px':'0';
    td.style.overflow=zoneColExpanded?'visible':'hidden';
    td.style.padding=zoneColExpanded?'0.5rem 0.65rem':'0.5rem 0';
  });
  document.querySelectorAll('.zone-col-content').forEach(el=>el.style.display=zoneColExpanded?'block':'none');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXCL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let commentExcl=false;
function toggleExcl(){commentExcl=!commentExcl;document.getElementById('excl-btn').classList.toggle('on',commentExcl);}
function resetExcl(){commentExcl=false;document.getElementById('excl-btn').classList.remove('on');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIME & PACE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseTime(str){
  if(!str) return null;
  const parts=str.trim().split(':');
  if(parts.length===2){const m=parseInt(parts[0],10),s=parseInt(parts[1],10);if(isNaN(m)||isNaN(s)||s<0||s>59)return null;return m*60+s;}
  if(parts.length===3){const h=parseInt(parts[0],10),m=parseInt(parts[1],10),s=parseInt(parts[2],10);if(isNaN(h)||isNaN(m)||isNaN(s)||m>59||s>59)return null;return h*3600+m*60+s;}
  return null;
}
function formatDuration(sec){
  if(!sec||sec<=0)return'â€”';
  const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60;
  if(h>0)return`${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  return`${m}:${String(s).padStart(2,'0')}`;
}
function calcPaceStr(d,s){
  if(!d||!s||d<=0||s<=0)return null;
  const ps=s/d,pm=Math.floor(ps/60),ss=Math.round(ps%60);
  return ss===60?`${pm+1}:00`:`${pm}:${String(ss).padStart(2,'0')}`;
}
const distInp=document.getElementById('f-distance');
const durInp=document.getElementById('f-duration');
const paceInp=document.getElementById('f-pace');
function updatePaceLive(){const p=calcPaceStr(parseFloat(distInp.value),parseTime(durInp.value));paceInp.value=p?p+' min/km':'';}
distInp.addEventListener('input',updatePaceLive);
durInp.addEventListener('input',updatePaceLive);
durInp.addEventListener('blur',()=>{const r=durInp.value.trim();if(/^\d{3,4}$/.test(r)){durInp.value=`${r.slice(0,r.length-2)}:${r.slice(-2)}`;updatePaceLive();}});
[1,2,3,4,5].forEach(z=>{
  document.getElementById(`zt-${z}`).addEventListener('blur',()=>{
    const i=document.getElementById(`zt-${z}`),r=i.value.trim();
    if(/^\d{3,4}$/.test(r))i.value=`${r.slice(0,r.length-2)}:${r.slice(-2)}`;
  });
});
document.getElementById('f-date').value=todayISO();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDIT STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingId=null;
function enterEditMode(id){
  const t=loadTrainings().find(x=>x.id===id); if(!t) return;
  editingId=id;
  document.getElementById('f-date').value=t.date||todayISO();
  document.getElementById('f-activity').value=t.activity||'bieg';
  document.getElementById('f-type').value=t.type||'baza tlenowa';
  distInp.value=t.distance||'';
  const ds=formatDuration(t.durationSeconds); durInp.value=ds!=='â€”'?ds:'';
  document.getElementById('f-accent').value=t.accent||'';
  document.getElementById('f-note').value=t.note||'';
  const tv=t.task||''; document.getElementById('f-task').value=tv;
  if(tv&&!taskVisible)toggleTask(); else if(!tv&&taskVisible)toggleTask();
  commentExcl=!!t.commentExcl; document.getElementById('excl-btn').classList.toggle('on',commentExcl);
  selectedRPE=t.rpe||null; refreshRPE(); updatePaceLive();
  const zt=t.zoneTimes||{};
  [1,2,3,4,5].forEach(z=>{const v=zt[z]?formatDuration(zt[z]):'';document.getElementById(`zt-${z}`).value=v!=='â€”'?v:'';});
  const hz=Object.values(zt).some(v=>v>0);
  if(hz&&!zoneTimeVisible)toggleZoneTime(); else if(!hz&&zoneTimeVisible)toggleZoneTime();
  document.getElementById('add-btn').textContent='ğŸ’¾ Zapisz zmiany';
  document.getElementById('cancel-btn').style.display='inline-block';
  document.getElementById('edit-banner').classList.add('visible');
  document.getElementById('form-card').classList.add('editing');
  clearPlanSource();
  switchTab('endurance');
  document.getElementById('form-card').scrollIntoView({behavior:'smooth',block:'start'});
}
function cancelEdit(){editingId=null;resetForm();}
function resetForm(){
  editingId=null;
  document.getElementById('f-date').value=todayISO();
  document.getElementById('f-activity').value='bieg';
  document.getElementById('f-type').value='baza tlenowa';
  distInp.value=''; durInp.value='';
  document.getElementById('f-accent').value='';
  document.getElementById('f-note').value='';
  document.getElementById('f-task').value='';
  selectedRPE=null; refreshRPE(); paceInp.value='';
  resetExcl();
  [1,2,3,4,5].forEach(z=>document.getElementById(`zt-${z}`).value='');
  if(taskVisible)toggleTask();
  if(zoneTimeVisible)toggleZoneTime();
  document.getElementById('add-btn').textContent='+ Dodaj trening';
  document.getElementById('cancel-btn').style.display='none';
  document.getElementById('edit-banner').classList.remove('visible');
  document.getElementById('form-card').classList.remove('editing');
  document.getElementById('form-error').style.display='none';
  clearPlanSource();
  renderEndurance();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD / SAVE TRAINING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('add-btn').addEventListener('click',()=>{
  const date=document.getElementById('f-date').value;
  const activity=document.getElementById('f-activity').value;
  const type=document.getElementById('f-type').value;
  const distance=parseFloat(distInp.value);
  const durationSeconds=parseTime(durInp.value);
  const accent=parseFloat(document.getElementById('f-accent').value)||0;
  const note=document.getElementById('f-note').value.trim();
  const task=document.getElementById('f-task').value.trim();
  if(!date){showError('Podaj datÄ™.');return;}
  if(!distance||distance<=0){showError('Podaj dystans.');return;}
  if(!durationSeconds||durationSeconds<=0){showError('Podaj czas (mm:ss lub hh:mm:ss).');return;}
  document.getElementById('form-error').style.display='none';
  const zoneTimes={};
  [1,2,3,4,5].forEach(z=>{const s=parseTime(document.getElementById(`zt-${z}`).value);if(s&&s>0)zoneTimes[z]=s;});
  const record={date,activity,type,distance,durationSeconds,accent,rpe:selectedRPE,note,commentExcl,zoneTimes,task};
  const all=loadTrainings();
  if(editingId!==null){
    const idx=all.findIndex(x=>x.id===editingId);
    if(idx!==-1)all[idx]={...all[idx],...record};
  } else {
    all.push({id:Date.now(),...record});
  }
  saveTrainings(all);
  // remove linked plan
  if(pendingPlanId!==null){
    savePlanned(loadPlanned().filter(x=>x.id!==pendingPlanId));
    pendingPlanId=null;
  }
  resetForm();
});
function showError(msg){const el=document.getElementById('form-error');el.textContent=msg;el.style.display='inline';setTimeout(()=>el.style.display='none',4000);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELETE / EDIT (global)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.deleteTraining=function(id){
  if(!confirm('UsunÄ…Ä‡ ten trening?'))return;
  if(editingId===id)cancelEdit();
  saveTrainings(loadTrainings().filter(x=>x.id!==id));
  renderEndurance();
  if(document.getElementById('tab-history').classList.contains('active'))renderHistory();
};
window.editTraining=function(id){enterEditMode(id);};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DISPLAY HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function typeTagClass(type){
  switch(type){
    case 'baza tlenowa':  return'tag-type-blue';
    case 'zabawa biegowa':return'tag-type-green';
    case 'okoÅ‚o progowy': return'tag-type-orange';
    case 'interwaÅ‚owy':   return'tag-type-orange';
    case 'ciÄ…gÅ‚y':        return'tag-type-green';
    default:              return'tag-type-blue';
  }
}
function commentCellHTML(note,excl){
  if(!note||!note.trim())return`<span style="color:var(--border);">â€”</span>`;
  const icon=excl
    ?`<span style="display:inline-flex;align-items:center;gap:0.1rem;font-size:0.95rem;">ğŸ’¬<span style="font-size:0.82rem;font-weight:900;color:#b45309;">â—</span></span>`
    :`<span style="font-size:0.95rem;">ğŸ’¬</span>`;
  return`<span class="comment-cell" onclick="this.classList.toggle('open');event.stopPropagation();">${icon}<div class="tooltip-box">${escHtml(note)}</div></span>`;
}
function zoneTimesHTML(zt){
  const parts=[];
  for(let z=1;z<=5;z++){const s=zt&&zt[z]?zt[z]:0;parts.push(`<span>S${z}-${s>0?formatDuration(s):'00:00'}</span>`);}
  return`<div class="zone-time-cell">${parts.join('')}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildTableHTML(rows,mode){
  const sortable=mode==='full';
  if(rows.length===0)return`<div class="empty-state"><div class="big">ğŸƒ</div><p class="font-semibold" style="color:var(--muted);">Brak treningÃ³w</p></div>`;

  const compactCols=[
    {key:'date',label:'Data'},{key:'activity',label:'Akt.'},{key:'type',label:'Typ'},
    {key:'',label:'Zadanie',taskCol:true},{key:'rpe',label:'RPE'},
    {key:'distance',label:'Dystans'},{key:'time',label:'Czas'},{key:'pace',label:'Tempo'},
    {key:'',label:'Kom.'},{key:'',label:''},
  ];
  const fullCols=[
    {key:'date',label:'Data'},{key:'activity',label:'Akt.'},{key:'type',label:'Typ'},
    {key:'',label:'Zadanie',taskCol:true},{key:'rpe',label:'RPE'},
    {key:'distance',label:'Dystans'},{key:'time',label:'Czas'},{key:'pace',label:'Tempo'},
    {key:'',label:'Kom.'},{key:'',label:'Strefy',zoneCol:true},{key:'',label:''},
  ];
  const cols=mode==='compact'?compactCols:fullCols;

  const thead=`<table class="data-table"><thead><tr>`+
    cols.map(h=>{
      if(h.zoneCol)return`<th class="zone-col-th" style="width:2.2rem;text-align:center;">Strefy<button class="zone-toggle-btn" id="zone-col-btn" onclick="toggleZoneCol()" title="PokaÅ¼/ukryj">+</button></th>`;
      if(h.taskCol)return`<th style="min-width:200px;max-width:280px;">${h.label}</th>`;
      if(!h.key||!sortable)return`<th>${h.label}</th>`;
      const cls=hSortCol===h.key?(hSortDir==='asc'?'sort-asc':'sort-desc'):'';
      return`<th data-col="${h.key}" class="sortable ${cls}">${h.label}<span class="sort-icon"></span></th>`;
    }).join('')+`</tr></thead><tbody>`;

  const tbody=rows.map(t=>{
    const pace=calcPaceStr(t.distance,t.durationSeconds);
    const dur=formatDuration(t.durationSeconds);
    const dot=rpeDotStyle(t.rpe);
    const rpeCell=t.rpe?`<span class="rpe-dot" style="background:${dot.bg};color:${dot.color};border:1.5px solid ${dot.border};">${t.rpe}</span>`:`<span style="color:var(--border);">â€”</span>`;
    const taskHTML=t.task?`<div class="task-cell">${escHtml(t.task)}</div>`:`<div class="task-cell empty">â€”</div>`;
    if(mode==='compact'){
      return`<tr>
        <td class="mono" style="white-space:nowrap;">${formatDatePL(t.date)}</td>
        <td><span class="tag-sm tag-activity">${escHtml(t.activity||'â€”')}</span></td>
        <td><span class="tag-sm ${typeTagClass(t.type)}">${escHtml(t.type||'â€”')}</span></td>
        <td style="min-width:200px;max-width:280px;">${taskHTML}</td>
        <td>${rpeCell}</td>
        <td class="mono">${t.distance} km</td>
        <td class="mono">${dur}</td>
        <td class="mono">${pace?pace+' /km':'â€”'}</td>
        <td>${commentCellHTML(t.note,t.commentExcl)}</td>
        <td style="white-space:nowrap;"><button class="row-btn" onclick="editTraining(${t.id})">Edytuj</button><button class="row-btn del" onclick="deleteTraining(${t.id})">UsuÅ„</button></td>
      </tr>`;
    } else {
      const col=!zoneColExpanded;
      return`<tr>
        <td class="mono" style="white-space:nowrap;">${formatDatePL(t.date)}</td>
        <td><span class="tag-sm tag-activity">${escHtml(t.activity||'â€”')}</span></td>
        <td><span class="tag-sm ${typeTagClass(t.type)}">${escHtml(t.type||'â€”')}</span></td>
        <td style="min-width:200px;max-width:280px;">${taskHTML}</td>
        <td>${rpeCell}</td>
        <td class="mono">${t.distance} km</td>
        <td class="mono">${dur}</td>
        <td class="mono">${pace?pace+' /km':'â€”'}</td>
        <td>${commentCellHTML(t.note,t.commentExcl)}</td>
        <td class="zone-col-td" style="max-width:${col?'0':'300px'};overflow:${col?'hidden':'visible'};padding:${col?'0.5rem 0':'0.5rem 0.65rem'};">
          <div class="zone-col-content" style="display:${col?'none':'block'};">${zoneTimesHTML(t.zoneTimes)}</div>
        </td>
        <td style="white-space:nowrap;"><button class="row-btn" onclick="editTraining(${t.id})">Edytuj</button><button class="row-btn del" onclick="deleteTraining(${t.id})">UsuÅ„</button></td>
      </tr>`;
    }
  }).join('');
  return thead+tbody+'</tbody></table>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ENDURANCE (last 5)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEndurance(){
  const sorted=loadTrainings().sort((a,b)=>b.date.localeCompare(a.date)).slice(0,5);
  document.getElementById('endurance-table-body').innerHTML=buildTableHTML(sorted,'compact');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY (sortable + multi-filters)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let hSortCol='date',hSortDir='desc';

function populateYearFilter(){
  const sel=document.getElementById('h-filter-year');
  const cur=sel.value;
  const years=[...new Set(loadTrainings().map(t=>t.date.split('-')[0]))].sort((a,b)=>b-a);
  sel.innerHTML='<option value="">Wszystkie</option>'+years.map(y=>`<option value="${y}"${y===cur?' selected':''}>${y}</option>`).join('');
}

function renderHistory(){
  let data=loadTrainings();
  const fy=document.getElementById('h-filter-year').value;
  const fr=document.getElementById('h-filter-rpe').value;
  const months=getMsValues('ms-month');
  const activities=getMsValues('ms-activity');
  const types=getMsValues('ms-type');

  if(fy) data=data.filter(t=>t.date.startsWith(fy));
  if(months.length>0) data=data.filter(t=>months.includes(t.date.split('-')[1]));
  if(activities.length>0) data=data.filter(t=>activities.includes(t.activity));
  if(types.length>0) data=data.filter(t=>types.includes(t.type));
  if(fr) data=data.filter(t=>String(t.rpe)===fr);

  data.sort((a,b)=>{
    let va,vb;
    switch(hSortCol){
      case 'date':     va=a.date;          vb=b.date;          break;
      case 'activity': va=a.activity||'';  vb=b.activity||'';  break;
      case 'type':     va=a.type||'';      vb=b.type||'';      break;
      case 'rpe':      va=a.rpe||0;        vb=b.rpe||0;        break;
      case 'distance': va=a.distance||0;   vb=b.distance||0;   break;
      case 'time':     va=a.durationSeconds||0; vb=b.durationSeconds||0; break;
      case 'pace':
        va=(a.distance&&a.durationSeconds)?a.durationSeconds/a.distance:0;
        vb=(b.distance&&b.durationSeconds)?b.durationSeconds/b.distance:0; break;
      default: va=a.date;vb=b.date;
    }
    if(va<vb)return hSortDir==='asc'?-1:1;
    if(va>vb)return hSortDir==='asc'?1:-1;
    return 0;
  });

  const wrap=document.getElementById('history-table-body');
  wrap.innerHTML=buildTableHTML(data,'full');
  wrap.querySelectorAll('th[data-col]').forEach(th=>{
    th.addEventListener('click',()=>{
      const col=th.dataset.col;
      if(hSortCol===col)hSortDir=hSortDir==='asc'?'desc':'asc';
      else{hSortCol=col;hSortDir='asc';}
      renderHistory();
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildZoneTable(){
  const tbody=document.getElementById('zone-tbody'); tbody.innerHTML='';
  ZONE_DISPLAY.forEach(({num,label,cls})=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><span class="${cls}">${label}</span></td>
      <td><input type="number" id="z${num}-bpm-min"   placeholder="â€”" min="0" oninput="validateZones()"/></td>
      <td><input type="number" id="z${num}-bpm-max"   placeholder="â€”" min="0" oninput="validateZones()"/></td>
      <td><input type="text"   id="z${num}-pace-min"  placeholder="5:00"/></td>
      <td><input type="text"   id="z${num}-pace-max"  placeholder="6:30"/></td>
      <td><input type="number" id="z${num}-power-min" placeholder="â€”" min="0" oninput="validateZones()"/></td>
      <td><input type="number" id="z${num}-power-max" placeholder="â€”" min="0" oninput="validateZones()"/></td>`;
    tbody.appendChild(tr);
  });
}
function validateZones(){
  let v=true;
  for(let z=1;z<=4;z++){
    const bm=parseInt(document.getElementById(`z${z}-bpm-max`).value)||0;
    const bm2=parseInt(document.getElementById(`z${z+1}-bpm-min`).value)||0;
    const pm=parseInt(document.getElementById(`z${z}-power-max`).value)||0;
    const pm2=parseInt(document.getElementById(`z${z+1}-power-min`).value)||0;
    if((bm>0&&bm2>0&&bm2<=bm)||(pm>0&&pm2>0&&pm2<=pm)){v=false;break;}
  }
  document.getElementById('zone-error').style.display=v?'none':'block';
  return v;
}
function saveProfile(){
  if(!validateZones())return;
  const p={height:document.getElementById('p-height').value,weight:document.getElementById('p-weight').value,zones:{}};
  for(let z=1;z<=5;z++){
    p.zones[z]={
      bpmMin:document.getElementById(`z${z}-bpm-min`).value,
      bpmMax:document.getElementById(`z${z}-bpm-max`).value,
      powerMin:document.getElementById(`z${z}-power-min`).value,
      powerMax:document.getElementById(`z${z}-power-max`).value,
      paceMin:document.getElementById(`z${z}-pace-min`).value,
      paceMax:document.getElementById(`z${z}-pace-max`).value,
    };
  }
  saveProfileData(p);
  const el=document.getElementById('profile-saved');
  el.style.display='inline';setTimeout(()=>el.style.display='none',2500);
}
function loadProfileUI(){
  const p=loadProfile();
  if(p.height)document.getElementById('p-height').value=p.height;
  if(p.weight)document.getElementById('p-weight').value=p.weight;
  if(p.zones){
    for(let z=1;z<=5;z++){
      const zd=p.zones[z]; if(!zd)continue;
      document.getElementById(`z${z}-bpm-min`).value  =zd.bpmMin  ||'';
      document.getElementById(`z${z}-bpm-max`).value  =zd.bpmMax  ||'';
      document.getElementById(`z${z}-power-min`).value=zd.powerMin||'';
      document.getElementById(`z${z}-power-max`).value=zd.powerMax||'';
      document.getElementById(`z${z}-pace-min`).value =zd.paceMin ||'';
      document.getElementById(`z${z}-pace-max`).value =zd.paceMax ||'';
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
migrateData();
seedData();
buildZoneTable();
loadProfileUI();
renderEndurance();
renderPlanned();
</script>
</body>
</html>
